<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ·±æ·µçµæ‰‹ï¼šå¥§è¡“ç¶­åº¦ v7.8</title>
    <style>
        :root { --bg: #000; --ui: #1c1c1c; --border: #3498db; --accent: #f1c40f; --wall: #34495e; --floor: #1a121a; }
        body { background: var(--bg); color: #eee; font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; display: flex; align-items: center; justify-content: center; margin: 0; height: 100vh; overflow: hidden; }
        .game-layout { display: flex; gap: 15px; width: 98vw; height: 95vh; justify-content: center; }
        .sidebar { width: 340px; background: var(--ui); padding: 15px; border: 2px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; gap: 10px; }
        .stat-line { font-size: 14px; border-bottom: 1px dotted #444; padding-bottom: 4px; display: flex; justify-content: space-between; }
        .stat-val { color: var(--accent); font-weight: bold; }
        #game-area { border: 4px solid #444; background: #000; border-radius: 10px; overflow: hidden; position: relative; }
        canvas { display: block; }
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 450px; background: #222; border: 3px solid var(--accent); padding: 25px; display: none; z-index: 1000; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.9); }
        .btn-opt { background: #333; border: 1px solid #555; padding: 12px; color: #fff; cursor: pointer; border-radius: 10px; margin-bottom: 8px; }
        .btn-opt:hover { background: #444; border-color: var(--accent); }
        .opt-header { display: flex; justify-content: space-between; font-weight: bold; color: var(--accent); }
        .opt-desc { font-size: 12px; color: #bbb; margin-top: 4px; line-height: 1.4; }
        .spell-card { background: #252525; padding: 8px; border-radius: 6px; margin-top: 5px; border-left: 4px solid #9b59b6; font-size: 12px; }
        .log { flex-grow: 1; background: #000; padding: 10px; font-size: 12px; overflow-y: auto; color: #ccc; border-radius: 6px; border: 1px solid #333; line-height: 1.5; }
    </style>
</head>
<body>

<div id="game-modal" class="modal">
    <h2 id="modal-title" style="text-align:center; color:var(--accent); margin:0;">ğŸ›ï¸</h2>
    <div id="modal-content"></div>
    <button onclick="closeModal()" style="width:100%; margin-top:20px; padding:12px; cursor:pointer; background:#555; color:white; border:none; border-radius:8px;">é›¢é–‹é›¢é–‹</button>
</div>

<div class="game-layout">
    <div class="sidebar">
        <h3 style="text-align:center; margin:0; color:#2ecc71">Lv.<span id="s-lv">1</span> å¥§è¡“å¤§å¸«</h3>
        <div class="stat-line"><span>â¤ï¸ ç”Ÿå‘½</span> <span id="s-hp" class="stat-val">100/100</span></div>
        <div class="stat-line"><span>ğŸ§ª é­”åŠ›</span> <span id="s-mp" class="stat-val">30/30</span></div>
        <div class="stat-line"><span>âš”ï¸ è¿‘æˆ°åŠ›é‡</span> <span id="s-atk" class="stat-val">10</span></div>
        <div class="stat-line"><span>ğŸ”® é­”æ³•è¡“åŠ›</span> <span id="s-mgk" class="stat-val">10</span></div>
        <div class="stat-line"><span>ğŸ’° æŒæœ‰é‡‘å¹£</span> <span id="s-gold" class="stat-val">100</span></div>
        <div id="spell-ui"></div>
        <div class="log" id="log"></div>
    </div>
    <div id="game-area"><canvas id="gameCanvas"></canvas></div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 26, GW = 40, GH = 30;
let floor = 1, gold = 100, lv = 1, exp = 0, nextExp = 100;
let dungeon = [], enemies = [], effects = [], buildings = [];
let playerSpells = ['Q'], ownedPassives = [];

const SPELL_DATA = {
    'Q': { n: 'ç«çƒè¡“', mp: 3, cd: 2, sc: 1.5, d: 'å‘åå­—æ–¹å‘ç™¼å°„ç«èˆŒ', eff: 'é€ æˆ è¡“åŠ›Ã—1.5 çš„é­”æ³•å‚·å®³', p: 0 },
    'E': { n: 'å†°çˆ†è¡“', mp: 7, cd: 4, sc: 1.2, d: 'ä»¥è‡ªèº«ç‚ºä¸­å¿ƒ5x5ç¯„åœå¼•çˆ†', eff: 'é€ æˆ è¡“åŠ›Ã—1.2 å‚·å®³ä¸¦å‡çµ2å›åˆ', p: 180 },
    'F': { n: 'è¬åŠè¨£', mp: 12, cd: 8, sc: 1.0, d: 'å¬å–šç„¡æ•¸é£›åŠæ©«æƒæˆ°å ´', eff: 'å°ç•«é¢ä¸Šæ‰€æœ‰æ•µäººé€²è¡Œ2æ¬¡æ™®é€šæ”»æ“Š', p: 300 },
    'V': { n: 'è–å…‰æ²»ç™’', mp: 5, cd: 10, sc: 0, d: 'ä½¿ç”¨ç¥è–èƒ½é‡ä¿®å¾©èº«é«”', eff: 'ç«‹å³å›å¾© 40 é»ç”Ÿå‘½å€¼', p: 150 }
};

const PASSIVE_POOL = [
    { id: "p1", n: "ğŸ©¸ å—œè¡€", d: "è¿‘æˆ°æ“Šæ®ºå›å¾© 8 é» HP" },
    { id: "p2", n: "ğŸ§˜ å†¥æƒ³", d: "é€²å…¥æ–°æ¨“å±¤å›å¾© 15 é» MP" },
    { id: "p3", n: "ğŸŒµ èŠæ£˜", d: "å—å‚·åå½ˆ 30% å‚·å®³" },
    { id: "p4", n: "ğŸ¹ å¥§è¡“åŠ å¼·", d: "æ³•è¡“å‚·å®³æå‡ 20%" },
    { id: "p7", n: "ğŸ›¡ï¸ ç¡¬åŒ–è­·ç”²", d: "å›ºå®šæ¸›å°‘ 3 é»å—åˆ°çš„å‚·å®³" },
    { id: "p10", n: "ğŸŒªï¸ é–ƒé¿ç›´è¦º", d: "15% æ©Ÿç‡å®Œå…¨é–ƒé¿ç‰©ç†æ”»æ“Š" },
    { id: "p14", n: "ğŸ”± ç¥è–ç©¿é€", d: "ç„¡è¦–æ•µæ–¹é˜²ç¦¦åŠ›" },
    { id: "p17", n: "ğŸ”‹ èƒ½æºæ”¶é›†", d: "æ¯èµ° 5 æ­¥å›å¾© 1 é» MP" },
    { id: "p20", n: "âš”ï¸ åŠè¡“å°ˆç²¾", d: "è¿‘æˆ°æ”»æ“Šæœ‰ 20% æ©Ÿç‡é€ æˆé›™å€å‚·å®³" }
    // ... æ›´å¤šè¢«å‹•å·²åœ¨æ­¤å…§éƒ¨é‚è¼¯è™•ç†
];

let player = { x: 20, y: 15, maxHp: 100, hp: 100, maxMp: 30, mp: 30, atk: 10, mgk: 10, def: 0, cd: {}, stepCount: 0 };

function initLevel() {
    document.getElementById('log').innerHTML = `<div style="color:#f1c40f; font-weight:bold;">ã€ ç¬¬ ${floor} å±¤ æ¢ç´¢é–‹å§‹ ã€‘</div>`;
    canvas.width = GW * TILE; canvas.height = GH * TILE;
    dungeon = Array(GH).fill().map(() => Array(GW).fill(1));
    enemies = []; effects = []; buildings = [];
    
    let cx = 20, cy = 15; player.x = cx; player.y = cy;
    for(let i=0; i<850; i++) {
        dungeon[cy][cx] = 0;
        let d = Math.floor(Math.random()*4);
        if(d===0 && cy>1) cy--; else if(d===1 && cy<GH-2) cy++;
        else if(d===2 && cx>1) cx--; else if(d===3 && cx<GW-2) cx++;
    }

    let mod = floor % 10;
    let count = (mod === 0) ? 1 : (3 + mod);
    for(let i=0; i<count; i++) spawnEnemy(mod === 0);

    if([1,3,5,7,9].includes(mod)) buildings.push(createBuilding("é“å…·åº—", "ğŸ±"));
    if([2,4,6,8].includes(mod)) buildings.push(createBuilding("éµåŒ é‹ª", "âš’ï¸"));
    if([4,8].includes(mod)) buildings.push(createBuilding("é­”æ³•å•†åº—", "ğŸ”®"));
    if(mod === 5) buildings.push(createBuilding("è¨“ç·´æ‰€", "âš”ï¸"));

    placeSpec(2); 
    buildings.forEach(b => placeBuilding(b));
    updateUI();
}

function createBuilding(type, icon) { return { type, icon, x: 0, y: 0 }; }
function placeBuilding(b) {
    let x, y;
    do { x = 2 + Math.floor(Math.random()*(GW-4)); y = 2 + Math.floor(Math.random()*(GH-4)); } 
    while (dungeon[y][x] !== 0 || Math.abs(x-player.x)+Math.abs(y-player.y) < 5);
    b.x = x; b.y = y;
    for(let i=-1; i<=1; i++) for(let j=-1; j<=1; j++) dungeon[y+i][x+j] = 0;
}

function spawnEnemy(isBoss) {
    let x, y;
    do { x = Math.floor(Math.random()*GW); y = Math.floor(Math.random()*GH); } while(dungeon[y][x] !== 0);
    let hp = Math.floor(((60 + (floor*12)) * (isBoss ? 15 : 1)) / 2);
    enemies.push({
        x, y, isBoss, hp, maxHp: hp,
        atk: Math.floor((6 + floor) * (isBoss ? 2 : 1) / 2),
        emoji: isBoss ? "ğŸ‘‘" : ["ğŸ‘º", "ğŸ’€", "ğŸ‘»", "ğŸ¦‡"][Math.floor(Math.random()*4)],
        wounded: false, freeze: 0
    });
}

function placeSpec(v) {
    let x, y;
    do { x = Math.floor(Math.random()*GW); y = Math.floor(Math.random()*GH); } 
    while (dungeon[y][x] !== 0 || Math.abs(x-player.x)+Math.abs(y-player.y) < 8);
    dungeon[y][x] = v;
}

function draw() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
    for(let y=0; y<GH; y++) {
        for(let x=0; x<GW; x++) {
            ctx.fillStyle = (dungeon[y][x] === 1) ? "#34495e" : "#1a121a";
            ctx.fillRect(x * TILE, y * TILE, TILE - 1, TILE - 1);
            if(dungeon[y][x] === 2) { ctx.font = `${TILE*0.8}px Arial`; ctx.fillText("ğŸªœ", x*TILE+2, y*TILE+TILE-4); }
        }
    }
    buildings.forEach(b => { ctx.font = `${TILE*0.8}px Arial`; ctx.fillText(b.icon, b.x*TILE+2, b.y*TILE+TILE-4); });
    enemies.forEach(en => {
        ctx.font = `${TILE * 0.9}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        if(en.freeze > 0) { ctx.shadowBlur = 10; ctx.shadowColor = "#3498db"; }
        else if(en.isBoss) { ctx.shadowBlur = 10; ctx.shadowColor = "red"; }
        ctx.fillText(en.emoji, en.x*TILE + TILE/2, en.y*TILE + TILE/2); ctx.shadowBlur = 0;
        if(en.wounded) {
            ctx.fillStyle = "#333"; ctx.fillRect(en.x*TILE+2, en.y*TILE, TILE-4, 3);
            ctx.fillStyle = "#e74c3c"; ctx.fillRect(en.x*TILE+2, en.y*TILE, (TILE-4)*(en.hp/en.maxHp), 3);
        }
    });
    ctx.font = `${TILE * 0.9}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText("ğŸ§™â€â™‚ï¸", player.x*TILE + TILE/2, player.y*TILE + TILE/2);
    effects.forEach((eff, i) => {
        ctx.globalAlpha = eff.l/10; ctx.fillStyle = eff.c || "#f1c40f";
        ctx.fillRect(eff.x * TILE, eff.y * TILE, TILE, TILE);
        eff.l--; if(eff.l<=0) effects.splice(i,1);
    });
    ctx.globalAlpha = 1; ctx.textAlign = "start"; ctx.textBaseline = "alphabetic";
}

function dealDamage(t, isMgk, key) {
    let crit = (!isMgk && hasP("p20") && Math.random() < 0.2);
    let base = isMgk ? player.mgk : player.atk;
    if(isMgk && hasP("p4")) base *= 1.2;

    let sc = (key && key !== 'F') ? SPELL_DATA[key].sc : 1;
    let dmg = Math.floor(base * sc * (crit ? 2 : 1));
    
    t.hp -= dmg; t.wounded = true;
    
    if(key) {
        addLog(`ğŸ”® ã€${SPELL_DATA[key].n}ã€‘ å‘½ä¸­ï¼Œé€ æˆ ${dmg} å‚·å®³`);
    } else {
        addLog(`âš”ï¸ æ–¬æ“Šé€ æˆ ${dmg} å‚·å®³${crit ? ' (è‡´å‘½ä¸€æ“Š!)' : ''}`, crit ? "#f1c40f" : "");
    }

    if(key === 'E') t.freeze = 2;
    if(t.hp <= 0) {
        addLog(`ğŸ’€ æ“Šæ®ºäº† ${t.emoji}! ç¶“é©—å€¼èˆ‡é‡‘å¹£å¢åŠ `);
        if(!isMgk && hasP("p1")) player.hp = Math.min(player.maxHp, player.hp + 8);
        gold += (t.isBoss ? 500 : 30);
        gainExp(t.isBoss ? 400 : 40);
        enemies = enemies.filter(e => e !== t);
    }
}

function hasP(id) { return ownedPassives.some(p => p.id === id); }

function endTurn() {
    Object.keys(player.cd).forEach(k => { if(player.cd[k]>0) player.cd[k]--; });
    if(hasP("p17")) { player.stepCount++; if(player.stepCount>=5){ player.mp=Math.min(player.maxMp, player.mp+1); player.stepCount=0; } }
    
    enemies.forEach(en => {
        if(en.freeze > 0) { en.freeze--; return; }
        let dist = Math.abs(player.x-en.x) + Math.abs(player.y-en.y);
        if(dist === 1) {
            if(hasP("p10") && Math.random() < 0.15) { addLog("ğŸŒªï¸ é–ƒé¿æˆåŠŸ! æœªå—åˆ°å‚·å®³", "#3498db"); return; }
            let d = Math.max(1, en.atk - player.def);
            if(hasP("p7")) d = Math.max(1, d - 3);
            player.hp -= d; addLog(`ğŸ’¥ å—åˆ° ${en.emoji} æ”»æ“Šï¼Œæå¤± ${d} ç”Ÿå‘½`, "#ff4757");
            if(hasP("p3")) { let r = Math.floor(d*0.3); en.hp -= r; addLog(`ğŸŒµ èŠæ£˜åéœ‡äº† ${r} å‚·å®³`); }
        } else {
            let dx = (dist < 8) ? Math.sign(player.x-en.x) : Math.floor(Math.random()*3)-1;
            let dy = (dist < 8) ? Math.sign(player.y-en.y) : Math.floor(Math.random()*3)-1;
            let nx = en.x + dx, ny = en.y + dy;
            if(nx>=0 && nx<GW && ny>=0 && ny<GH && dungeon[ny][nx]===0 && !enemies.some(e=>e!==en && e.x===nx && e.y===ny) && !(player.x===nx && player.y===ny) && !buildings.some(b=>b.x===nx && b.y===ny)) {
                en.x = nx; en.y = ny;
            }
        }
    });
    if(player.hp <= 0) { alert("æˆ°æ•—ï¼"); location.reload(); }
    updateUI();
}

function gainExp(a) {
    exp += a; if(exp >= nextExp) { 
        lv++; exp -= nextExp; nextExp = Math.floor(nextExp * 1.5); 
        player.maxHp += 10; player.hp += 10; player.maxMp += 2; player.mp += 2;
        addLog("âœ¨ã€ç­‰ç´šæå‡ã€‘ æˆ°é¬¥å±¬æ€§å¢å¼·ï¼", "#2ecc71");
    }
}

function updateUI() {
    document.getElementById('s-hp').innerText = `${Math.floor(player.hp)}/${player.maxHp}`;
    document.getElementById('s-mp').innerText = `${Math.floor(player.mp)}/${player.maxMp}`;
    document.getElementById('s-atk').innerText = player.atk;
    document.getElementById('s-mgk').innerText = player.mgk;
    document.getElementById('s-gold').innerText = gold;
    let sUI = document.getElementById('spell-ui');
    sUI.innerHTML = `<b style="color:var(--border);font-size:12px;">ğŸ“œ æŠ€èƒ½ç‹€æ…‹:</b>`;
    playerSpells.forEach(k => { sUI.innerHTML += `<div class="spell-card"><b>[${k}] ${SPELL_DATA[k].n}</b><br><small>å†·å»: ${player.cd[k]||0} | æ¶ˆè€—: ${SPELL_DATA[k].mp}</small></div>`; });
}

function openModal(b) {
    const m = document.getElementById('game-modal'); const c = document.getElementById('modal-content');
    document.getElementById('modal-title').innerText = b.icon + " " + b.type;
    m.style.display = 'block'; c.innerHTML = "";
    
    let options = [];
    if(b.type === "è¨“ç·´æ‰€") {
        options = PASSIVE_POOL.filter(p => !hasP(p.id)).sort(() => 0.5 - Math.random()).slice(0, 3).map(p => ({ n: p.n, d: p.d, f: () => { ownedPassives.push(p); buildings = buildings.filter(ob => ob !== b); }}));
    } else if(b.type === "é“å…·åº—") {
        options = [{ n: "ğŸ§ª æ²»ç™’è—¥æ°´", d: "æ¢å¾©å…¨ç”Ÿå‘½", p: 40, f: () => player.hp = player.maxHp }, { n: "âš¡ èƒ½é‡åŠ‘", d: "æ¢å¾© 25 MP", p: 30, f: () => player.mp = Math.min(player.maxMp, player.mp+25) }];
    } else if(b.type === "éµåŒ é‹ª") {
        options = [{ n: "âš”ï¸ ç£¨ç¤ªåˆƒå£", d: "æå‡ 5 é»è¿‘æˆ°æ”»æ“ŠåŠ›", p: 60, f: () => player.atk += 5 }, { n: "ğŸ›¡ï¸ å¼·åŒ–ç”²å†‘", d: "æå‡ 2 é»ç‰©ç†é˜²ç¦¦", p: 60, f: () => player.def += 2 }];
    } else if(b.type === "é­”æ³•å•†åº—") {
        Object.keys(SPELL_DATA).forEach(k => { 
            if(!playerSpells.includes(k)) {
                let s = SPELL_DATA[k];
                options.push({ n: `ğŸ“œ ${s.n}`, d: `${s.d}<br>æ•ˆæœï¼š${s.eff}`, p: s.p, f: () => playerSpells.push(k) });
            }
        });
    }

    options.forEach(it => {
        let div = document.createElement('div'); div.className = "btn-opt";
        div.innerHTML = `<div class="opt-header"><span>${it.n}</span><span>${it.p ? 'ğŸ’°'+it.p : 'é¸æ“‡'}</span></div><div class="opt-desc">${it.d}</div>`;
        div.onclick = () => { if(!it.p || gold >= it.p) { if(it.p) gold -= it.p; it.f(); if(b.type === "è¨“ç·´æ‰€") closeModal(); else openModal(b); updateUI(); } };
        c.appendChild(div);
    });
}

function closeModal() { document.getElementById('game-modal').style.display = 'none'; }
function addLog(m, c) { let d = document.createElement('div'); if(c) d.style.color=c; d.innerHTML = "> "+m; let l = document.getElementById('log'); l.prepend(d); }

window.addEventListener('keydown', e => {
    if(document.getElementById('game-modal').style.display === 'block') return;
    let k = e.key.toUpperCase(), dx = 0, dy = 0;
    if(k==='W') dy = -1; else if(k==='S') dy = 1; else if(k==='A') dx = -1; else if(k==='D') dx = 1;
    
    // ç§»å‹•/æ”»æ“Šé‚è¼¯ä¿®å¾©
    if(dx!==0 || dy!==0) {
        let nx = player.x+dx, ny = player.y+dy;
        if(nx>=0 && nx<GW && ny>=0 && ny<GH) {
            let en = enemies.find(e=>e.x===nx && e.y===ny);
            let b = buildings.find(b=>b.x===nx && b.y===ny);
            
            if(en) { // æ”»æ“Šæ•µäººï¼Œä¸ç§»å‹•
                dealDamage(en, false, null);
                endTurn();
            } else if(b) { // é€²å…¥å»ºç¯‰
                openModal(b);
            } else if(dungeon[ny][nx]===0) { // ç§»å‹•åˆ°ç©ºåœ°
                player.x = nx; player.y = ny;
                endTurn();
            } else if(dungeon[ny][nx]===2) { // æ¢¯å­
                floor++; initLevel();
            }
        }
    }
    
    // æ³•è¡“
    if(SPELL_DATA[k] && playerSpells.includes(k) && player.mp >= SPELL_DATA[k].mp && !player.cd[k]) {
        player.mp -= SPELL_DATA[k].mp; player.cd[k] = SPELL_DATA[k].cd;
        if(k==='Q') {
            [[0,-1],[0,1],[-1,0],[1,0]].forEach(dir => { for(let i=1; i<8; i++) {
                let tx=player.x+dir[0]*i, ty=player.y+dir[1]*i;
                if(tx<0||tx>=GW||ty<0||ty>=GH||dungeon[ty][tx]===1) break;
                effects.push({x:tx, y:ty, l:5, c: "#e67e22"});
                let t = enemies.find(e=>e.x===tx && e.y===ty); if(t) { dealDamage(t, true, 'Q'); break; }
            }});
        } else if(k==='E') {
            for(let x=player.x-2; x<=player.x+2; x++) for(let y=player.y-2; y<=player.y+2; y++) {
                if(x>=0&&x<GW&&y>=0&&y<GH){ effects.push({x, y, l:10, c:"#3498db"}); let t = enemies.find(e=>e.x===x && e.y===y); if(t) dealDamage(t, true, 'E'); }
            }
        } else if(k==='F') { // è¬åŠè¨£é‡è£½ï¼šå…¨é«”æ”»æ“Šå…©æ¬¡
            addLog("âš”ï¸ ã€è¬åŠè¨£ã€‘ è¬åŠé½Šç™¼ï¼å…¨å ´æ©«æƒå…©æ¬¡", "#9b59b6");
            let targets = [...enemies];
            targets.forEach(en => {
                effects.push({x:en.x, y:en.y, l:12, c:"#fff"});
                dealDamage(en, false, 'F');
                setTimeout(() => { if(enemies.includes(en)) dealDamage(en, false, 'F'); }, 100);
            });
        } else if(k==='V') { player.hp = Math.min(player.maxHp, player.hp+40); addLog("âœ¨ã€è–å…‰æ²»ç™’ã€‘ å›å¾©äº† 40 ç”Ÿå‘½å€¼", "#2ecc71"); }
        endTurn();
    }
});

initLevel();
setInterval(draw, 40);
</script>
</body>
</html>
