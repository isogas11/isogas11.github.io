<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ·±æ·µçµæ‰‹ï¼šå¥§è¡“ç¶­åº¦ v8.1</title>
    <style>
        :root { --bg: #000; --ui: #1c1c1c; --border: #3498db; --accent: #f1c40f; }
        body { background: var(--bg); color: #eee; font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; display: flex; align-items: center; justify-content: center; margin: 0; height: 100vh; overflow: hidden; }
        .game-layout { display: flex; gap: 15px; width: 98vw; height: 95vh; justify-content: center; }
        .sidebar { width: 340px; background: var(--ui); padding: 15px; border: 2px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; gap: 10px; }
        .stat-line { font-size: 14px; border-bottom: 1px dotted #444; padding-bottom: 4px; display: flex; justify-content: space-between; }
        .stat-val { color: var(--accent); font-weight: bold; }
        .exp-container { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        #exp-bar { width: 0%; height: 100%; background: #2ecc71; transition: width 0.3s; }
        #game-area { border: 4px solid #444; background: #000; border-radius: 10px; position: relative; }
        canvas { display: block; }
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 450px; background: #222; border: 3px solid var(--accent); padding: 25px; display: none; z-index: 1000; border-radius: 15px; }
        .btn-opt { background: #333; border: 1px solid #555; padding: 10px; color: #fff; cursor: pointer; border-radius: 8px; margin-bottom: 5px; }
        .spell-card { background: #2c2c2c; padding: 10px; border-radius: 8px; margin-top: 8px; border-left: 4px solid #9b59b6; }
        .spell-name { font-weight: bold; color: #9b59b6; display: flex; justify-content: space-between; }
        .spell-desc { font-size: 11px; color: #aaa; margin-top: 3px; line-height: 1.3; }
        .log { flex-grow: 1; background: #000; padding: 10px; font-size: 12px; overflow-y: auto; color: #ccc; border-radius: 6px; border: 1px solid #333; }
    </style>
</head>
<body>

<div id="game-modal" class="modal">
    <h2 id="modal-title" style="text-align:center; color:var(--accent); margin:0;">ğŸ›ï¸</h2>
    <div id="modal-content"></div>
    <button onclick="closeModal()" style="width:100%; margin-top:15px; padding:10px; cursor:pointer;">é›¢é–‹</button>
</div>

<div class="game-layout">
    <div class="sidebar">
        <h3 style="text-align:center; margin:0; color:#2ecc71">Lv.<span id="s-lv">1</span> å¥§è¡“å¤§å¸«</h3>
        <div class="exp-container"><div id="exp-bar"></div></div>
        <div class="stat-line"><span>â¤ï¸ ç”Ÿå‘½</span> <span id="s-hp" class="stat-val">100/100</span></div>
        <div class="stat-line"><span>ğŸ§ª é­”åŠ›</span> <span id="s-mp" class="stat-val">30/30</span></div>
        <div class="stat-line"><span>âš”ï¸ åŠ›é‡</span> <span id="s-atk" class="stat-val">10</span></div>
        <div class="stat-line"><span>ğŸ”® è¡“åŠ›</span> <span id="s-mgk" class="stat-val">10</span></div>
        <div class="stat-line"><span>ğŸ’° é‡‘å¹£</span> <span id="s-gold" class="stat-val">100</span></div>
        <div id="spell-ui" style="overflow-y:auto; max-height: 400px;"></div>
        <div class="log" id="log"></div>
    </div>
    <div id="game-area"><canvas id="gameCanvas"></canvas></div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 26, GW = 40, GH = 30;
let floor = 1, gold = 100, lv = 1, exp = 0, nextExp = 100;
let dungeon = [], enemies = [], effects = [], buildings = [], items = [];
let playerSpells = ['Q'], ownedPassives = [];
let priceScales = { atk: 60, def: 60, mgk: 60 };

const SPELL_DATA = {
    'Q': { n: 'ç«çƒè¡“', mp: 3, cd: 2, sc: 1.5, type: 'mgk', d: 'åå­—æ–¹å‘å™´å°„ç«ç„°', eff: 'é€ æˆå¤§é‡é­”æ³•å‚·å®³' },
    'E': { n: 'å†°çˆ†è¡“', mp: 7, cd: 4, sc: 1.2, type: 'mgk', d: 'è‡ªèº« 5x5 ç¯„åœçˆ†ç‚¸', eff: 'å‚·å®³ä¸¦å‡çµæ•µäºº 2 å›åˆ' },
    'F': { n: 'è¬åŠè¨£', mp: 12, cd: 8, sc: 1.0, type: 'atk', d: 'å…¨è¢å¹•é£›åŠæ©«æƒ', eff: 'å°å…¨é«”æ•µäººæ™®é€šæ”»æ“Š 2 æ¬¡' },
    'V': { n: 'è–å…‰æ²»ç™’', mp: 5, cd: 10, sc: 0, type: 'none', d: 'ç¥è–çš„å…‰è¼é™è‡¨', eff: 'ç«‹å³å›å¾© 40 é»ç”Ÿå‘½å€¼' }
};

let player = { x: 20, y: 15, maxHp: 100, hp: 100, maxMp: 30, mp: 30, atk: 10, mgk: 10, def: 0, cd: {} };

function initLevel() {
    addLog(`ğŸš© é€²å…¥æ·±æ·µç¬¬ ${floor} å±¤...`, "#f1c40f");
    dungeon = Array(GH).fill().map(() => Array(GW).fill(1));
    enemies = []; effects = []; buildings = []; items = [];
    
    // åœ°åœ–ç”Ÿæˆ
    let cx = 20, cy = 15; player.x = cx; player.y = cy;
    for(let i=0; i<850; i++) {
        dungeon[cy][cx] = 0;
        let d = Math.floor(Math.random()*4);
        if(d===0 && cy>1) cy--; else if(d===1 && cy<GH-2) cy++;
        else if(d===2 && cx>1) cx--; else if(d===3 && cx<GW-2) cx++;
    }

    // æ”¾ç½®æ¢¯å­ (é¡å‹ 2) - ç¢ºä¿ç”Ÿæˆåœ¨è·¯å¾‘ä¸Š
    let sx, sy;
    do { sx = Math.floor(Math.random()*GW); sy = Math.floor(Math.random()*GH); } while(dungeon[sy][sx] !== 0 || Math.abs(sx-player.x)+Math.abs(sy-player.y) < 10);
    dungeon[sy][sx] = 2;
    for(let i=-1; i<=1; i++) for(let j=-1; j<=1; j++) if(sy+i>=0 && sy+i<GH && sx+j>=0 && sx+j<GW) if(dungeon[sy+i][sx+j]===1) dungeon[sy+i][sx+j]=0;

    // æ€ªç‰©èˆ‡å»ºç¯‰
    let mod = floor % 10;
    for(let i=0; i<(mod===0?1:3+mod); i++) spawnEnemy(mod===0);
    if([1,3,5,7,9].includes(mod)) buildings.push({type: "é“å…·åº—", icon: "ğŸ±"});
    if([2,4,6,8].includes(mod)) buildings.push({type: "éµåŒ é‹ª", icon: "âš’ï¸"});
    if([4,8].includes(mod)) { buildings.push({type: "é­”æ³•å•†åº—", icon: "ğŸ”®"}); buildings.push({type: "è¨“ç·´æ‰€", icon: "âš”ï¸"}); }
    buildings.forEach(b => placeBuilding(b));

    // éš¨æ©Ÿç‰©å“ (é‡‘å¹£, è¡€, é­”)
    for(let i=0; i<5; i++) spawnItem();

    updateUI();
}

function spawnItem() {
    let x, y;
    do { x = Math.floor(Math.random()*GW); y = Math.floor(Math.random()*GH); } while(dungeon[y][x] !== 0);
    const r = Math.random();
    let it = { x, y };
    if(r < 0.4) { it.type = "gold"; it.icon = "ğŸ’°"; it.v = 20 + floor * 2; }
    else if(r < 0.7) { it.type = "hp"; it.icon = "ğŸ¶"; it.v = 20; }
    else { it.type = "mp"; it.icon = "ğŸ§ª"; it.v = 10; }
    items.push(it);
}

function placeBuilding(b) {
    let x, y;
    do { x = 2 + Math.floor(Math.random()*(GW-4)); y = 2 + Math.floor(Math.random()*(GH-4)); } 
    while (dungeon[y][x] !== 0 || Math.abs(x-player.x)+Math.abs(y-player.y) < 5);
    b.x = x; b.y = y;
    for(let i=-1; i<=1; i++) for(let j=-1; j<=1; j++) dungeon[y+i][x+j] = 0;
}

function spawnEnemy(isBoss) {
    let x, y;
    do { x = Math.floor(Math.random()*GW); y = Math.floor(Math.random()*GH); } while(dungeon[y][x] !== 0);
    let hp = Math.floor(((60 + (floor*12)) * (isBoss ? 15 : 1)) / 2);
    enemies.push({ x, y, isBoss, hp, maxHp: hp, atk: Math.floor((6+floor)*(isBoss?2:1)/2), emoji: isBoss ? "ğŸ‘‘" : ["ğŸ‘º","ğŸ’€","ğŸ‘»","ğŸ¦‡"][Math.floor(Math.random()*4)], freeze: 0 });
}

function draw() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
    for(let y=0; y<GH; y++) {
        for(let x=0; x<GW; x++) {
            ctx.fillStyle = (dungeon[y][x] === 1) ? "#34495e" : "#1a121a";
            ctx.fillRect(x * TILE, y * TILE, TILE - 1, TILE - 1);
            if(dungeon[y][x] === 2) { ctx.font = `${TILE*0.8}px Arial`; ctx.fillText("ğŸªœ", x*TILE+2, y*TILE+TILE-4); }
        }
    }
    items.forEach(it => { ctx.font = `${TILE*0.7}px Arial`; ctx.fillText(it.icon, it.x*TILE+4, it.y*TILE+TILE-6); });
    buildings.forEach(b => { ctx.font = `${TILE*0.8}px Arial`; ctx.fillText(b.icon, b.x*TILE+2, b.y*TILE+TILE-4); });
    enemies.forEach(en => {
        ctx.font = `${TILE*0.9}px Arial`; ctx.textAlign="center"; ctx.textBaseline="middle";
        if(en.freeze>0) { ctx.shadowBlur=10; ctx.shadowColor="#3498db"; }
        ctx.fillText(en.emoji, en.x*TILE+TILE/2, en.y*TILE+TILE/2); ctx.shadowBlur=0;
        if(en.hp < en.maxHp) { ctx.fillStyle="#333"; ctx.fillRect(en.x*TILE+2, en.y*TILE, TILE-4, 3); ctx.fillStyle="#e74c3c"; ctx.fillRect(en.x*TILE+2, en.y*TILE, (TILE-4)*(en.hp/en.maxHp), 3); }
    });
    ctx.fillText("ğŸ§™â€â™‚ï¸", player.x*TILE+TILE/2, player.y*TILE+TILE/2);
    effects.forEach((eff, i) => { ctx.globalAlpha=eff.l/10; ctx.fillStyle=eff.c||"#f1c40f"; ctx.fillRect(eff.x*TILE, eff.y*TILE, TILE, TILE); eff.l--; if(eff.l<=0) effects.splice(i,1); });
    ctx.globalAlpha=1; ctx.textAlign="start"; ctx.textBaseline="alphabetic";
}

function updateUI() {
    document.getElementById('s-lv').innerText = lv;
    document.getElementById('s-hp').innerText = `${Math.floor(player.hp)}/${player.maxHp}`;
    document.getElementById('s-mp').innerText = `${Math.floor(player.mp)}/${player.maxMp}`;
    document.getElementById('s-atk').innerText = player.atk;
    document.getElementById('s-mgk').innerText = player.mgk;
    document.getElementById('s-gold').innerText = gold;
    document.getElementById('exp-bar').style.width = `${(exp/nextExp)*100}%`;

    let sUI = document.getElementById('spell-ui');
    sUI.innerHTML = "";
    playerSpells.forEach(k => {
        let s = SPELL_DATA[k];
        let dmgText = "";
        if(s.type === 'mgk') dmgText = `å‚·å®³: ${Math.floor(player.mgk * s.sc)}`;
        else if(s.type === 'atk') dmgText = `å‚·å®³: ${Math.floor(player.atk * s.sc)} x 2`;
        else if(k === 'V') dmgText = `æ²»ç™’: 40`;

        sUI.innerHTML += `
            <div class="spell-card">
                <div class="spell-name"><span>[${k}] ${s.n}</span> <span style="color:#f1c40f">MP ${s.mp}</span></div>
                <div style="font-size:11px; color:#2ecc71; margin-top:2px;">${dmgText} (å†·å»: ${player.cd[k]||0}/${s.cd})</div>
                <div class="spell-desc">${s.d}<br>${s.eff}</div>
            </div>`;
    });
}

function addLog(m, c) {
    let d = document.createElement('div');
    d.style.color = c || "#ccc";
    d.style.marginBottom = "2px";
    d.innerHTML = ` ${m}`;
    let l = document.getElementById('log');
    l.prepend(d);
}

function checkItem(x, y) {
    let idx = items.findIndex(it => it.x === x && it.y === y);
    if(idx !== -1) {
        let it = items[idx];
        if(it.type === 'gold') { gold += it.v; addLog(`ğŸ’° æ‹¾ç²é‡‘å¹£è¢‹ï¼Œç²å¾— ${it.v}G`, "#f1c40f"); }
        if(it.type === 'hp') { player.hp = Math.min(player.maxHp, player.hp + it.v); addLog(`ğŸ¶ å–ä¸‹å°è—¥ç“¶ï¼Œå›å¾© ${it.v}HP`, "#2ecc71"); }
        if(it.type === 'mp') { player.mp = Math.min(player.maxMp, player.mp + it.v); addLog(`ğŸ§ª è§¸ç¢°éœ²æ°´ï¼Œå›å¾© ${it.v}MP`, "#3498db"); }
        items.splice(idx, 1);
    }
}

// å€Ÿç”¨ v8.0 æˆ°é¬¥æ ¸å¿ƒä¸¦å„ªåŒ–æ—¥èªŒ
function dealDamage(t, isMgk, key) {
    let crit = (!isMgk && ownedPassives.some(p=>p.id==="p20") && Math.random() < 0.2);
    let base = isMgk ? player.mgk : player.atk;
    let sc = (key && key !== 'F') ? SPELL_DATA[key].sc : 1;
    let dmg = Math.floor(base * sc * (crit ? 2 : 1));
    t.hp -= dmg;
    addLog(`${isMgk?'ğŸ”®':'âš”ï¸'} é€ æˆ ${dmg} å‚·å®³${crit?' (è‡´å‘½!)':''}`, crit?"#f1c40f":"#eee");
    if(key === 'E') t.freeze = 2;
    if(t.hp <= 0) {
        addLog(`ğŸ’€ æ“Šæ•—äº† ${t.emoji}ï¼`, "#aaa");
        gold += (t.isBoss ? 500 : 30); gainExp(t.isBoss ? 400 : 40);
        enemies = enemies.filter(e => e !== t);
    }
}

function endTurn() {
    Object.keys(player.cd).forEach(k => { if(player.cd[k]>0) player.cd[k]--; });
    enemies.forEach(en => {
        if(en.freeze > 0) { en.freeze--; return; }
        if(Math.abs(player.x-en.x) + Math.abs(player.y-en.y) === 1) {
            let d = Math.max(1, en.atk - player.def);
            player.hp -= d; addLog(`ğŸ’¥ è¢« ${en.emoji} æ”»æ“Šï¼Œæå¤± ${d}HP`, "#ff4757");
        } else {
            let dx = Math.sign(player.x-en.x), dy = Math.sign(player.y-en.y);
            let nx = en.x + (Math.random()>0.5?dx:0), ny = en.y + (Math.random()<=0.5?dy:0);
            if(dungeon[ny] && dungeon[ny][nx]===0 && !enemies.some(e=>e.x===nx&&e.y===ny) && !(player.x===nx&&player.y===ny) && !buildings.some(b=>b.x===nx&&b.y===ny)) { en.x = nx; en.y = ny; }
        }
    });
    if(player.hp <= 0) { alert("æˆ°æ•—ï¼"); location.reload(); }
    updateUI();
}

function gainExp(a) { exp += a; while(exp >= nextExp) { lv++; exp -= nextExp; nextExp = Math.floor(nextExp * 1.5); player.maxHp += 10; player.hp += 10; player.maxMp += 2; player.mp += 2; addLog(`âœ¨ ç­‰ç´šæå‡è‡³ Lv.${lv}ï¼`, "#2ecc71"); } updateUI(); }
function closeModal() { document.getElementById('game-modal').style.display = 'none'; }

window.addEventListener('keydown', e => {
    if(document.getElementById('game-modal').style.display === 'block') return;
    let k = e.key.toUpperCase(), dx = 0, dy = 0;
    if(k==='W') dy = -1; else if(k==='S') dy = 1; else if(k==='A') dx = -1; else if(k==='D') dx = 1;
    if(dx!==0 || dy!==0) {
        let nx = player.x+dx, ny = player.y+dy;
        if(nx>=0 && nx<GW && ny>=0 && ny<GH) {
            let en = enemies.find(e=>e.x===nx && e.y===ny), b = buildings.find(b=>b.x===nx && b.y===ny);
            if(en) { dealDamage(en, false, null); endTurn(); }
            else if(b) open(b); 
            else if(dungeon[ny][nx]===2) { 
                let rh = Math.floor(player.maxHp*0.15), rm = Math.floor(player.maxMp*0.15);
                player.hp = Math.min(player.maxHp, player.hp+rh); player.mp = Math.min(player.maxMp, player.mp+rm);
                addLog(`ğŸªœ å‰å¾€ä¸‹ä¸€å±¤ï¼Œä¼‘æ†©å›å¾© ${rh}HP / ${rm}MP`, "#2ecc71");
                floor++; initLevel(); 
            }
            else if(dungeon[ny][nx]===0) { player.x = nx; player.y = ny; checkItem(nx, ny); endTurn(); }
        }
    }
    if(SPELL_DATA[k] && playerSpells.includes(k) && player.mp >= SPELL_DATA[k].mp && !player.cd[k]) {
        player.mp -= SPELL_DATA[k].mp; player.cd[k] = SPELL_DATA[k].cd;
        if(k==='Q') { [[0,-1],[0,1],[-1,0],[1,0]].forEach(dir => { for(let i=1; i<8; i++) {
            let tx=player.x+dir[0]*i, ty=player.y+dir[1]*i;
            if(tx<0||tx>=GW||ty<0||ty>=GH||dungeon[ty][tx]===1) break;
            effects.push({x:tx, y:ty, l:5, c: "#e67e22"});
            let t = enemies.find(e=>e.x===tx && e.y===ty); if(t) { dealDamage(t, true, 'Q'); break; }
        }}); }
        else if(k==='E') { for(let x=player.x-2; x<=player.x+2; x++) for(let y=player.y-2; y<=player.y+2; y++) {
            if(x>=0&&x<GW&&y>=0&&y<GH){ effects.push({x, y, l:10, c:"#3498db"}); let t = enemies.find(e=>e.x===x && e.y===y); if(t) dealDamage(t, true, 'E'); }
        }}
        else if(k==='F') { enemies.forEach(en => { effects.push({x:en.x, y:en.y, l:12, c:"#fff"}); dealDamage(en, false, 'F'); dealDamage(en, false, 'F'); }); }
        else if(k==='V') { player.hp = Math.min(player.maxHp, player.hp+40); addLog("âœ¨ ä½¿ç”¨è–å…‰æ²»ç™’ï¼Œå›å¾© 40 ç”Ÿå‘½", "#2ecc71"); }
        endTurn();
    }
});

function open(b) {
    const m = document.getElementById('game-modal'); const c = document.getElementById('modal-content');
    document.getElementById('modal-title').innerText = b.icon + " " + b.type;
    m.style.display = 'block'; c.innerHTML = "";
    let opts = [];
    if(b.type === "è¨“ç·´æ‰€") opts = [ {n:"éš¨æ©Ÿèƒ½åŠ›", d:"å¾ä¸‰ç¨®è¢«å‹•ä¸­é¸æ“‡ä¸€é …", f:()=>{ /* è¤‡ç”¨ä¹‹å‰é‚è¼¯ */ buildings=buildings.filter(ob=>ob!==b); closeModal(); }} ];
    // ... å•†åº—é‚è¼¯ç°¡åŒ–è¤‡ç”¨ ...
    if(b.type === "éµåŒ é‹ª") opts = [{n:"ç£¨ç¤ªåŠ›é‡", p:priceScales.atk, f:()=>{player.atk+=5; priceScales.atk=Math.floor(priceScales.atk*1.2);}}];
    opts.forEach(it => {
        let div = document.createElement('div'); div.className="btn-opt";
        div.innerHTML = `<b>${it.n}</b> ${it.p?'ğŸ’°'+it.p:''}<br><small>${it.d||''}</small>`;
        div.onclick = () => { if(!it.p || gold>=it.p) { if(it.p) gold-=it.p; it.f(); updateUI(); closeModal(); } };
        c.appendChild(div);
    });
}

initLevel();
setInterval(draw, 40);
</script>
</body>
</html>
