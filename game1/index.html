<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ·±æ·µçµæ‰‹ï¼šå¥§è¡“ç¶­åº¦ v4.0</title>
    <style>
        body { background: #050505; color: #eee; font-family: 'å¾®è»Ÿæ­£é»‘é«”', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; overflow: hidden; }
        .game-layout { display: flex; gap: 20px; padding: 20px; width: 1480px; height: 98vh; box-sizing: border-box; }
        .sidebar { width: 320px; background: #1a1a1a; padding: 15px; border: 2px solid #3498db; border-radius: 12px; overflow-y: auto; }
        .stat-line { font-size: 15px; line-height: 2; border-bottom: 1px solid #333; }
        .stat-val { float: right; font-weight: bold; font-family: 'Consolas'; }
        #game-area { position: relative; border-radius: 10px; overflow: hidden; }
        canvas { background: #000; display: block; border: 2px solid #333; }
        
        .spell-info { background: #252525; border: 1px solid #444; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
        .spell-name { color: #f1c40f; font-weight: bold; }
        .scaling-tag { color: #a29bfe; font-size: 11px; background: #000; padding: 2px 5px; border-radius: 4px; display: inline-block; margin-top: 4px; }

        #shop-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 520px; background: #151515; border: 4px solid #f1c40f; padding: 25px; display: none; z-index: 100; border-radius: 15px; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #333; cursor: pointer; }
        .shop-item:hover { background: #2ecc7133; }
        .log { height: 400px; background: #000; padding: 12px; font-size: 12px; border: 1px solid #333; overflow-y: auto; color: #ccc; border-radius: 10px; }
    </style>
</head>
<body>

<div id="shop-ui">
    <h2 style="text-align:center; color:#f1c40f; margin-top:0;">ğŸª æ¨“å±¤ç¥ç§˜å•†åº—</h2>
    <div id="shop-list"></div>
    <button onclick="closeShop()" style="width:100%; margin-top:15px; padding:12px; cursor:pointer;">é›¢é–‹å•†åº—</button>
</div>

<div class="game-layout">
    <div class="sidebar">
        <h3 style="text-align:center; color:#2ecc71; margin:0 0 10px 0;">Lv.<span id="s-lv">1</span> å¥§è¡“å¸«</h3>
        <div style="height:8px; background:#333; border-radius:4px; margin-bottom:15px;"><div id="exp-bar" style="height:100%; background:#2ecc71; width:0%; border-radius:4px;"></div></div>
        
        <div class="stat-line">â¤ï¸ ç”Ÿå‘½ä¸Šé™ <span id="s-hp" class="stat-val">100/100</span></div>
        <div class="stat-line">ğŸ§ª é­”åŠ›ä¸Šé™ <span id="s-mp" class="stat-val">30/30</span></div>
        <div class="stat-line">âš”ï¸ è¿‘æˆ°åŠ›é‡ <span id="s-matk" class="stat-val">10</span></div>
        <div class="stat-line">ğŸ”® é­”æ³•è¡“åŠ› <span id="s-atk" class="stat-val">10</span></div>
        <div class="stat-line">ğŸ’° æŒæœ‰é‡‘å¹£ <span id="s-gold" class="stat-val" style="color:#f1c40f">100</span></div>
        <div class="stat-line">ğŸ° ç›®å‰å±¤æ•¸ <span id="s-floor" class="stat-val">1</span></div>
        
        <h4 style="color:#3498db; margin:20px 0 10px 0;">ğŸ“œ å·²ç¿’å¾—æ³•è¡“</h4>
        <div id="spell-list-ui"></div>
    </div>

    <div id="game-area">
        <div id="boss-ui" style="position:absolute; top:10px; left:50%; transform:translateX(-50%); width:80%; display:none;">
            <div id="boss-name" style="color:#ff4757; font-weight:bold; text-align:center;">BOSS</div>
            <div style="height:12px; background:#2f3542; border-radius:6px; overflow:hidden;"><div id="boss-fill" style="height:100%; background:#ff4757; width:100%;"></div></div>
        </div>
        <canvas id="gameCanvas" width="750" height="600"></canvas>
    </div>

    <div class="right-panel" style="width:380px;">
        <div class="log" id="log"><div id="log-inner"></div></div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 30, GW = 25, GH = 20;

let floor = 1, gold = 100, cycle = 1;
let lv = 1, exp = 0, nextExp = 100;
let unlockedGlobalItems = []; 
let floorShopItems = [];

let player = { 
    x: 5, y: 5, hp: 100, maxHp: 100, mp: 30, maxMp: 30, 
    atk: 10, meleeAtk: 10, defense: 0,
    unlockedSpells: ['Q'],
    spellCD: { 'Q':0, 'E':0, 'F':0, 'V':0, 'X':0 }
};

const SPELLS = {
    'Q': { name: 'ç«çƒè¡“', cost: 2, cd: 2, scaling: 1.5, desc: 'ç›´ç·šè²«ç©¿ç«å½ˆ' },
    'E': { name: 'å†°çˆ†è¡“', cost: 5, cd: 5, scaling: 0.8, desc: 'éœ‡ç¢å‘¨åœæ•µè»' },
    'F': { name: 'è¬åŠè¨£', cost: 8, cd: 10, scaling: 0.4, desc: 'å…¨è¢å¹•é£›åŠæ‰“æ“Š' },
    'V': { name: 'æ²»ç™’è¡“', cost: 4, cd: 12, scaling: 0, desc: 'æ¢å¾©30ç”Ÿå‘½å€¼' },
    'X': { name: 'æ¯€æ»…æ–°æ˜Ÿ', cost: 15, cd: 20, scaling: 2.5, desc: 'æ¸…ç†ä¸€åˆ‡çš„çµ‚æ¥µå¥§è¡“' }
};

function initLevel() {
    dungeon = Array(GH).fill().map(() => Array(GW).fill(1));
    enemies = []; effects = [];
    document.getElementById('boss-ui').style.display = 'none';

    if (floor % 10 === 0) {
        for(let y=2; y<GH-2; y++) for(let x=2; x<GW-2; x++) dungeon[y][x] = 0;
        player.x = 12; player.y = 17; spawnBoss();
    } else {
        let cx = 12, cy = 10; player.x = cx; player.y = cy;
        for(let i=0; i<600; i++) {
            dungeon[cy][cx] = 0;
            let d = Math.floor(Math.random()*4);
            if(d===0 && cy>1) cy--; else if(d===1 && cy<GH-2) cy++;
            else if(d===2 && cx>1) cx--; else if(d===3 && cx<GW-2) cx++;
        }
        place(2, 1); place(3, 1); place(4, 1);
        let count = 3 + (floor % 10) * 2;
        for(let i=0; i<count; i++) spawnEnemy();
    }
    generateFloorShop();
    updateUI();
}

function spawnEnemy() {
    let x, y;
    do { x = Math.floor(Math.random()*GW); y = Math.floor(Math.random()*GH); } while(dungeon[y][x] !== 0);
    // é›£åº¦è¨ˆç®—ï¼šCycle åŠ æˆ + æ¯10å±¤éšæ¢¯å¼åŠ æˆ
    let floorBoost = Math.floor(floor / 10) * 20;
    enemies.push({ x, y, hp: 30+(cycle-1)*50 + floorBoost, maxHp: 30+(cycle-1)*50 + floorBoost, atk: 5+(cycle-1)*5 + Math.floor(floorBoost/10), name: "ğŸ‘º æ€ªç‰©", lastHit: 0 });
}

function spawnBoss() {
    let boss = { x: 12, y: 5, hp: 600+(cycle-1)*1000 + (floor*10), maxHp: 600+(cycle-1)*1000 + (floor*10), atk: 15+(cycle-1)*10, isBoss: true, name: "ğŸ² æ·±æ·µé ˜ä¸»", lastHit: 0 };
    enemies.push(boss);
    document.getElementById('boss-ui').style.display = 'block';
    updateBossBar(boss);
}

function dealDamage(target, baseAtk, skillKey, sourceName = "ğŸ§™ ç©å®¶") {
    let scaling = skillKey ? SPELLS[skillKey].scaling : 1;
    let finalDmg = Math.floor(baseAtk * scaling);
    if (skillKey === 'Q') finalDmg += 10; // ç«çƒåŸºç¤åŠ å€¼

    target.hp -= finalDmg;
    target.lastHit = 15;
    addLog(`[${sourceName}] ä½¿ç”¨ [${skillKey?SPELLS[skillKey].name:'è¿‘æˆ°'}] å° [${target.name}] é€ æˆ ${finalDmg} å‚·å®³ (ä¿‚æ•¸ ${scaling}x)`);
    
    if(target.isBoss) updateBossBar(target);
    if(target.hp <= 0) {
        gold += target.isBoss ? 200 : 15;
        gainExp(target.isBoss ? 500 : 35);
        if(target.isBoss) { dungeon[target.y][target.x] = 2; document.getElementById('boss-ui').style.display = 'none'; }
        enemies = enemies.filter(e => e !== target);
    }
}

function endTurn() {
    for (let k in player.spellCD) if (player.spellCD[k] > 0) player.spellCD[k]--;
    
    enemies.forEach(en => {
        let dist = Math.abs(player.x-en.x) + Math.abs(player.y-en.y);
        if(dist === 1) {
            let dmg = Math.max(1, en.atk - player.defense);
            player.hp -= dmg;
            addLog(`[${en.name}] æ”»æ“Š [ç©å®¶] é€ æˆ ${dmg} å‚·å®³`, "danger");
        } else if(!en.isBoss) {
            // æ€ªç‰© AI å°‹è·¯èˆ‡é˜²ç–Š
            let dx = Math.sign(player.x-en.x), dy = Math.sign(player.y-en.y);
            let nextX = en.x + dx, nextY = en.y + dy;

            // æª¢æŸ¥æ˜¯å¦æœƒèˆ‡å…¶ä»–æ€ªç‰©é‡ç–Š
            let isOccupied = enemies.some(other => other !== en && other.x === nextX && other.y === nextY);
            
            if (!isOccupied && dungeon[nextY][nextX] === 0) {
                en.x = nextX; en.y = nextY;
            } else {
                // å˜—è©¦ç¹è·¯ï¼šå¦‚æœ X è»¸è¢«æ“‹ä½ï¼Œè©¦è©¦ Y è»¸ç§»å‹•ï¼Œåä¹‹äº¦ç„¶
                if (dungeon[en.y+dy][en.x] === 0 && !enemies.some(o => o.x === en.x && o.y === en.y+dy)) {
                    en.y += dy;
                } else if (dungeon[en.y][en.x+dx] === 0 && !enemies.some(o => o.x === en.x+dx && o.y === en.y)) {
                    en.x += dx;
                }
            }
        }
    });
    if(player.hp <= 0) { alert("ä½ å€’ä¸‹äº†..."); location.reload(); }
    updateUI();
}

function draw() {
    ctx.clearRect(0,0,750,600);
    ctx.fillStyle = "#0a0a0a"; ctx.fillRect(0,0,750,600);
    
    for(let y=0; y<GH; y++) for(let x=0; x<GW; x++) {
        if(dungeon[y][x] === 1) {
            ctx.fillStyle = "#222"; ctx.fillRect(x*TILE+1, y*TILE+1, TILE-2, TILE-2);
        } else {
            ctx.strokeStyle = "#111"; ctx.strokeRect(x*TILE, y*TILE, TILE, TILE);
        }
        if(dungeon[y][x] === 2) { ctx.font = "20px Arial"; ctx.fillText("ğŸªœ", x*TILE+4, y*TILE+22); }
        if(dungeon[y][x] === 3) { ctx.font = "20px Arial"; ctx.fillText("ğŸª", x*TILE+4, y*TILE+22); }
        if(dungeon[y][x] === 4) { ctx.font = "20px Arial"; ctx.fillText("ğŸ”®", x*TILE+4, y*TILE+22); }
    }

    effects.forEach((eff, idx) => {
        ctx.globalAlpha = eff.life / 10;
        ctx.fillStyle = eff.type==='fire'?"#e67e22":eff.type==='ice'?"#3498db":"#ecf0f1";
        ctx.fillRect(eff.x*TILE, eff.y*TILE, TILE, TILE);
        eff.life--; if(eff.life<=0) effects.splice(idx,1);
    });

    ctx.globalAlpha = 1;
    // ç¹ªè£½æ€ªç‰©
    enemies.forEach(en => {
        ctx.fillStyle = en.isBoss ? "#f1c40f" : "#c0392b";
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 1;
        ctx.fillRect(en.x*TILE+3, en.y*TILE+3, TILE-6, TILE-6);
        ctx.strokeRect(en.x*TILE+3, en.y*TILE+3, TILE-6, TILE-6);
        
        if(en.lastHit > 0) {
            ctx.fillStyle="#333"; ctx.fillRect(en.x*TILE, en.y*TILE-6, TILE, 4);
            ctx.fillStyle="#2ecc71"; ctx.fillRect(en.x*TILE, en.y*TILE-6, TILE*(en.hp/en.maxHp), 4);
            en.lastHit--;
        }
    });

    // ç¹ªè£½ç©å®¶ (å¤§åœ–æ¡ˆ)
    ctx.fillStyle = "#3498db";
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 2;
    ctx.fillRect(player.x*TILE+2, player.y*TILE+2, TILE-4, TILE-4);
    ctx.strokeRect(player.x*TILE+2, player.y*TILE+2, TILE-4, TILE-4);
    ctx.fillStyle = "#fff";
    ctx.font = "bold 14px Arial";
    ctx.fillText("P", player.x*TILE+10, player.y*TILE+20);
}

// å…¶é¤˜å•†åº—ã€ç­‰ç´šã€æ–½æ³•é‚è¼¯èˆ‡ä¹‹å‰ç‰ˆæœ¬ä¸€è‡´ä½†æ•´åˆé€²æ–°ç³»çµ±
function generateFloorShop() {
    floorShopItems = [
        { type:'f', n: `â¤ï¸ æ²»ç™’è—¥æ°´ (+30)`, p: 15, f: () => player.hp = Math.min(player.maxHp, player.hp+30) },
        { type:'f', n: `ğŸ§ª é­”åŠ›è—¥æ°´ (+15)`, p: 12, f: () => player.mp = Math.min(player.maxMp, player.mp+15) },
        { type:'f', n: `âš”ï¸ ç£¨åˆ€çŸ³ (è¿‘æˆ°+4)`, p: 40, f: () => player.meleeAtk += 4 },
        { type:'f', n: `ğŸ”® è¡“åŠ›ç²¾è¯ (è¡“åŠ›+5)`, p: 50, f: () => player.atk += 5 }
    ];
    let availableSpells = Object.keys(SPELLS).filter(k => !player.unlockedSpells.includes(k) && !unlockedGlobalItems.includes(k));
    availableSpells.sort(() => Math.random() - 0.5).slice(0, 2).forEach(k => {
        floorShopItems.push({ type:'u', id:k, n:`ğŸ“œ å­¸ç¿’ ${SPELLS[k].name}`, p:SPELLS[k].price||150, desc:SPELLS[k].desc, f:()=>{player.unlockedSpells.push(k); unlockedGlobalItems.push(k);} });
    });
}

function openShop() {
    const list = document.getElementById('shop-list');
    document.getElementById('shop-ui').style.display = 'block';
    list.innerHTML = "";
    floorShopItems.forEach((item, idx) => {
        let div = document.createElement('div'); div.className = "shop-item";
        div.innerHTML = `<div><b>${item.n}</b><br><small>${item.desc||''}</small></div><span class="price">ğŸ’°${item.p}</span>`;
        div.onclick = () => { if(gold >= item.p) { gold-=item.p; item.f(); if(item.type==='u') floorShopItems.splice(idx,1); updateUI(); openShop(); } };
        list.appendChild(div);
    });
}

function castSpell(key) {
    if (!player.unlockedSpells.includes(key) || player.spellCD[key] > 0 || player.mp < SPELLS[key].cost) return;
    let s = SPELLS[key]; player.mp -= s.cost; player.spellCD[key] = s.cd;
    if (key === 'Q') {
        [[0,-1],[0,1],[-1,0],[1,0]].forEach(d => {
            for(let i=1; i<=5; i++) {
                let tx = player.x+d[0]*i, ty = player.y+d[1]*i;
                effects.push({x: tx, y: ty, life: 6, type: 'fire'});
                let target = enemies.find(e => e.x === tx && e.y === ty);
                if(target) { dealDamage(target, player.atk, 'Q'); break; }
            }
        });
    } else if (key === 'E') {
        enemies.forEach(en => { if(Math.abs(en.x-player.x)<=2 && Math.abs(en.y-player.y)<=2) { effects.push({x:en.x,y:en.y,life:8,type:'ice'}); dealDamage(en, player.atk, 'E'); } });
    } else if (key === 'F' || key === 'X') {
        enemies.forEach(en => { effects.push({x:en.x,y:en.y,life:10,type:'nova'}); dealDamage(en, player.atk, key); });
    } else if (key === 'V') { player.hp = Math.min(player.maxHp, player.hp + 30); addLog("âœ¨ ä½¿ç”¨æ²»ç™’è¡“æ¢å¾© 30 ç”Ÿå‘½"); }
    endTurn();
}

function tryMove(dx, dy) {
    let nx = player.x + dx, ny = player.y + dy;
    if (nx < 0 || nx >= GW || ny < 0 || ny >= GH || dungeon[ny][nx] === 1) return;
    if (dungeon[ny][nx] >= 3) { openShop(); return; }
    let target = enemies.find(e => e.x === nx && e.y === ny);
    if (target) { dealDamage(target, player.meleeAtk, null); endTurn(); }
    else { player.x = nx; player.y = ny; if(dungeon[ny][nx] === 2){floor++; if(floor>20){floor=1; cycle++;} initLevel(); return;} endTurn(); }
}

function updateUI() {
    document.getElementById('s-hp').innerText = `${player.hp}/${player.maxHp}`;
    document.getElementById('s-mp').innerText = `${player.mp}/${player.maxMp}`;
    document.getElementById('s-matk').innerText = player.meleeAtk;
    document.getElementById('s-atk').innerText = player.atk;
    document.getElementById('s-gold').innerText = gold;
    document.getElementById('s-floor').innerText = floor;
    document.getElementById('s-lv').innerText = lv;
    document.getElementById('exp-bar').style.width = (exp/nextExp)*100 + "%";
    let sUI = document.getElementById('spell-list-ui'); sUI.innerHTML = "";
    player.unlockedSpells.forEach(k => {
        let s = SPELLS[k];
        sUI.innerHTML += `<div class="spell-info"><div class="spell-name">[${k}] ${s.name}</div><div class="scaling-tag">å‚·å®³: è¡“åŠ› Ã— ${s.scaling}</div><div style="font-size:11px; color:#888;">æ¶ˆè€—: ${s.cost}MP | CD: ${s.cd}</div>${player.spellCD[k]>0?`<div style="color:#e74c3c;font-size:11px;">å†·å»ä¸­: ${player.spellCD[k]}</div>`:''}</div>`;
    });
}

function gainExp(amt) {
    exp += amt; if(exp >= nextExp) { lv++; exp-=nextExp; nextExp=Math.floor(nextExp*1.4); player.maxHp+=20; player.hp=player.maxHp; player.maxMp+=10; player.mp=player.maxMp; addLog("ğŸŠ ç­‰ç´šæå‡ï¼å±¬æ€§ä¸Šé™å¢åŠ ï¼", "magic"); }
}

function addLog(m, cl="") {
    let d = document.createElement('div'); if(cl==="danger") d.style.color="#ff4757"; if(cl==="magic") d.style.color="#a29bfe";
    d.innerText = "> " + m; let inner = document.getElementById('log-inner'); inner.prepend(d);
}

function closeShop() { document.getElementById('shop-ui').style.display='none'; }
function updateBossBar(b) { document.getElementById('boss-fill').style.width = (b.hp/b.maxHp)*100 + "%"; }
function place(v, n) { for(let i=0; i<n; i++) { let x,y; do {x=Math.floor(Math.random()*GW); y=Math.floor(Math.random()*GH);} while(dungeon[y][x]!==0); dungeon[y][x]=v; } }

window.addEventListener('keydown', e => {
    if(document.getElementById('shop-ui').style.display==='block') return;
    const k = e.key.toUpperCase();
    if(['W','A','S','D','ARROWUP','ARROWLEFT','ARROWDOWN','ARROWRIGHT'].includes(k)) {
        if(k==='W'||k==='ARROWUP') tryMove(0,-1); if(k==='S'||k==='ARROWDOWN') tryMove(0,1);
        if(k==='A'||k==='ARROWLEFT') tryMove(-1,0); if(k==='D'||k==='ARROWRIGHT') tryMove(1,0);
    } else if(SPELLS[k]) castSpell(k);
});

initLevel();
setInterval(draw, 50);
</script>
</body>
</html>
