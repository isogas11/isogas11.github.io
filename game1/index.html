<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ·±æ·µçµæ‰‹ï¼šå¥§è¡“ä¸»å®° - å®Œæ•´æˆ°å ±ç‰ˆ</title>
    <style>
        body { background: #050505; color: #eee; font-family: 'Consolas', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; overflow: hidden; }
        .game-layout { display: flex; gap: 15px; padding: 15px; width: 1450px; height: 98vh; box-sizing: border-box; }
        .sidebar { width: 250px; background: #151515; padding: 15px; border: 2px solid #333; border-radius: 8px; }
        .stat-line { font-size: 14px; line-height: 2.2; border-bottom: 1px solid #222; }
        .stat-val { float: right; font-weight: bold; }
        #game-area { position: relative; }
        canvas { background: #000; border: 4px solid #3498db; }
        #boss-hp-bar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 500px; height: 12px; background: #333; border: 2px solid #fff; display: none; z-index: 10; }
        #boss-hp-fill { width: 100%; height: 100%; background: linear-gradient(to right, #c0392b, #ff0000); transition: 0.2s; }
        .right-panel { width: 400px; display: flex; flex-direction: column; gap: 10px; }
        .spell-card { background: #1e272e; padding: 8px; border: 1px solid #3d3d3d; border-radius: 5px; margin-bottom: 5px; opacity: 0.4; }
        .spell-card.unlocked { opacity: 1; border-color: #3498db; }
        .spell-key { background: #444; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold; margin-right: 5px; }
        .unlocked .spell-key { background: #3498db; }
        .log { height: 250px; background: #000; padding: 10px; font-size: 13px; border: 1px solid #333; overflow-y: auto; color: #aaa; border-radius: 8px; }
        #shop-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; background: #1a1a1a; border: 3px solid #f1c40f; padding: 20px; display: none; z-index: 100; border-radius: 10px; }
        .shop-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; cursor: pointer; }
        .shop-item:hover { background: #222; }
        .price { color: #f1c40f; font-weight: bold; }
        .important { color: #f1c40f; font-weight: bold; }
        .melee { color: #ecf0f1; }
    </style>
</head>
<body>

<div id="boss-hp-bar"><div id="boss-hp-fill"></div><div id="boss-name" style="position:absolute; width:100%; text-align:center; top:-20px; font-size:12px; color:white;"></div></div>

<div id="shop-ui">
    <h2 style="color:#f1c40f; text-align:center; margin-top:0;">ğŸ›’ å¥§è¡“ç¥ç§˜å•†åº—</h2>
    <div id="shop-list"></div>
    <button onclick="closeShop()" style="width:100%; margin-top:15px; padding:10px; background:#444; color:white; border:none; cursor:pointer;">é›¢é–‹å•†åº—</button>
</div>

<div class="game-layout">
    <div class="sidebar">
        <h3 style="color:#3498db; text-align:center;">ğŸ§™ å¥§è¡“ä¸»å®°</h3>
        <div class="stat-line">â¤ï¸ ç”Ÿå‘½ <span id="s-hp" class="stat-val" style="color:#e74c3c">100/100</span></div>
        <div class="stat-line">ğŸ§ª èƒ½é‡ <span id="s-mp" class="stat-val" style="color:#3498db">20/20</span></div>
        <div class="stat-line">âš”ï¸ è¡“åŠ› <span id="s-atk" class="stat-val" style="color:#9b59b6">20</span></div>
        <div class="stat-line">ğŸ’° é‡‘å¹£ <span id="s-gold" class="stat-val" style="color:#f1c40f">0</span></div>
        <div class="stat-line">ğŸŒ€ è¼ªè¿´ <span id="s-loop" class="stat-val">1</span></div>
        <div class="stat-line">ğŸ° å±¤æ•¸ <span id="s-floor" class="stat-val">1</span></div>
        <hr border="0" style="border-top:1px solid #333">
        <h4>å·²å­¸ç¿’é­”æ³•:</h4>
        <div id="spell-list-ui"></div>
    </div>

    <div id="game-area"><canvas id="gameCanvas" width="750" height="600"></canvas></div>

    <div class="right-panel">
        <div class="log" id="log"><div id="log-inner"></div></div>
        <div style="background:#151515; border:2px solid #333; padding:15px; border-radius:8px; flex-grow:1;">
            <h4 style="margin-top:0; color:#f1c40f;">ğŸ“œ å†’éšªæ—¥èªŒ</h4>
            <div id="boss-desc" style="font-size:13px; color:#999; line-height:1.6;">æ’å‘ç‰†å£æˆ–æ€ªç‰©å°‡æ¶ˆè€—å›åˆã€‚</div>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 30, GW = 25, GH = 20;

let floor = 1, gold = 100, mpRegenCounter = 0, loopCount = 1;
let player = { x: 5, y: 5, hp: 120, maxHp: 120, mp: 25, maxMp: 25, atk: 20, regen: 1, unlockedSpells: ['Q'] };
let dungeon = [], enemies = [], effects = [], moveHistory = [];

const SPELLS = {
    'Q': { name: 'ç«çƒè¡“', cost: 3, desc: 'ç›´ç·šè²«ç©¿é«˜å‚·', price: 0 },
    'E': { name: 'å†°çˆ†é™£', cost: 5, desc: '5x5å…¨æ–¹ä½å‡çµ', price: 150 },
    'R': { name: 'è¿”å›è¡“', cost: 2, desc: 'å›åˆ°5æ­¥å‰ä½ç½®', price: 100 },
    'F': { name: 'è¬åŠè¨£', cost: 8, desc: 'å…¨å±è¿½è¹¤è‡ªå‹•æ”»æ“Š', price: 300 },
    'V': { name: 'æ²»ç™’è¡“', cost: 6, desc: 'å›å¾©30%æœ€å¤§ç”Ÿå‘½å€¼', price: 200 },
    'G': { name: 'é‡åŠ›å ´', cost: 10, desc: 'å…¨å±å¤§å‚·+åœé “', price: 400 }
};

const BOSS_DATA = [
    { name: "åœ°ç„é ˜ä¸» - é˜¿åŠ é›·æ–¯", emoji: "ğŸ‘¹" },
    { name: "è™›ç©ºæš—å½± - è²åˆ©äº", emoji: "ğŸ‘»" },
    { name: "è²ªå©ªä¹‹ç‹ - ç‘ªé–€", emoji: "ğŸ‘º" },
    { name: "æ·±æ·µå·¨ç¸ - åˆ©ç¶­å¦", emoji: "ğŸ‰" }
];

function initLevel() {
    dungeon = Array(GH).fill().map(() => Array(GW).fill(1));
    enemies = []; effects = []; moveHistory = [];
    const isBossFloor = (floor % 5 === 0);
    
    if(isBossFloor) {
        for(let y=4; y<GH-4; y++) for(let x=4; x<GW-4; x++) dungeon[y][x] = 0;
        player.x = 12; player.y = 15;
        spawnBoss();
        document.getElementById('boss-hp-bar').style.display = 'block';
    } else {
        document.getElementById('boss-hp-bar').style.display = 'none';
        let cx = 12, cy = 10; player.x = cx; player.y = cy;
        for(let i=0; i<600; i++) {
            dungeon[cy][cx] = 0;
            let d = Math.floor(Math.random()*4);
            if(d===0 && cy>1) cy--; else if(d===1 && cy<GH-2) cy++;
            else if(d===2 && cx>1) cx--; else if(d===3 && cx<GW-2) cx++;
        }
        place(2, 1); place(3, 1);
        for(let i=0; i<3 + loopCount; i++) spawnEnemy();
    }
    updateUI();
}

function spawnEnemy() {
    let x, y;
    do { x = Math.floor(Math.random()*GW); y = Math.floor(Math.random()*GH); }
    while(dungeon[y][x] !== 0 || (x===player.x && y===player.y));
    let s = 1 + (loopCount-1)*0.5;
    enemies.push({ x, y, hp: (50+floor*5)*s, maxHp: (50+floor*5)*s, atk: (6+floor)*s, isFrozen: 0, type: 'mob', name: 'å°æ€ª' });
}

function spawnBoss() {
    let idx = (Math.floor(floor/5)-1)%4;
    let b = BOSS_DATA[idx];
    let s = 1 + (loopCount-1)*0.8;
    enemies.push({ x: 12, y: 7, hp: (1200+floor*100)*s, maxHp: (1200+floor*100)*s, atk: (25+floor)*s, type: 'boss', bossType: idx, emoji: b.emoji, timer: 0, shield: 0, name: b.name });
    document.getElementById('boss-name').innerText = b.name;
}

function place(val, n) {
    for(let i=0; i<n; i++) {
        let x, y;
        do { x = Math.floor(Math.random()*GW); y = Math.floor(Math.random()*GH); } while(dungeon[y][x] !== 0);
        dungeon[y][x] = val;
    }
}

/** æ ¸å¿ƒä¿®æ­£ï¼šåŠ å…¥è¿‘æˆ°æ—¥èªŒ **/
function tryMove(dx, dy) {
    let nx = player.x + dx, ny = player.y + dy;
    if (nx < 0 || nx >= GW || ny < 0 || ny >= GH) return;
    
    if (dungeon[ny][nx] === 1) {
        addLog("â›” æ’åˆ°äº†ç‰†å£ï¼", "info");
        return;
    }
    if (dungeon[ny][nx] === 3) { openShop(); return; }

    let target = enemies.find(e => e.x === nx && e.y === ny);
    if (target) {
        addLog(`âš”ï¸ [è¿‘æˆ°] å° ${target.name} é€ æˆäº† ${player.atk} å‚·å®³ï¼`, "melee");
        dealDamage(target, player.atk);
    } else {
        moveHistory.push({x: player.x, y: player.y});
        if (moveHistory.length > 10) moveHistory.shift();
        player.x = nx; player.y = ny;
        if (dungeon[ny][nx] === 2) { floor++; if(floor>20){loopCount++; floor=1;} initLevel(); return; }
    }
    endTurn();
}

function castSpell(key) {
    if (!player.unlockedSpells.includes(key)) return;
    let s = SPELLS[key];
    if (player.mp < s.cost) { addLog("ğŸ§ª èƒ½é‡ä¸è¶³ï¼", "danger"); return; }
    player.mp -= s.cost;
    addLog(`âœ¨ æ–½æ”¾ ${s.name}ï¼`, "magic");
    if(key==='Q'){
        [[0,-1],[0,1],[-1,0],[1,0]].forEach(d=>{
            for(let i=1; i<=5; i++){
                let tx=player.x+d[0]*i, ty=player.y+d[1]*i;
                effects.push({x:tx, y:ty, life:6, type:'fire'});
                let t=enemies.find(e=>e.x===tx&&e.y===ty);
                if(t){ dealDamage(t, player.atk*3); break; }
            }
        });
    } else if(key==='E'){
        for(let dy=-2; dy<=2; dy++) for(let dx=-2; dx<=2; dx++){
            let tx=player.x+dx, ty=player.y+dy;
            if(tx>=0 && tx<GW && ty>=0 && ty<GH){
                effects.push({x:tx, y:ty, life:10, type:'ice'});
                let t=enemies.find(e=>e.x===tx&&e.y===ty);
                if(t){ t.isFrozen=4; dealDamage(t, player.atk*2); }
            }
        }
    } else if(key==='R'){
        let tidx=Math.max(0, moveHistory.length-5);
        let pos=moveHistory[tidx];
        player.x=pos.x; player.y=pos.y;
        moveHistory=moveHistory.slice(0, tidx);
        effects.push({x:player.x, y:player.y, life:8, type:'ice'});
    } else if(key==='F'){
        enemies.forEach(en=>{ effects.push({x:en.x, y:en.y, life:10, type:'fire'}); dealDamage(en, player.atk*2); });
    } else if(key==='V'){
        player.hp=Math.min(player.maxHp, player.hp+player.maxHp*0.3);
        effects.push({x:player.x, y:player.y, life:10, type:'ice'});
    } else if(key==='G'){
        enemies.forEach(en=>{ en.isFrozen=2; dealDamage(en, 100); effects.push({x:en.x, y:en.y, life:12, type:'fire'}); });
    }
    endTurn();
}

function dealDamage(en, dmg) {
    if(en.shield > 0) { en.shield -= dmg; return; }
    en.hp -= dmg;
    if(en.hp <= 0) {
        if(en.type === 'boss') { addLog(`ğŸ† æ“Šæ•—ä¸»å®° ${en.name}ï¼`, "important"); dungeon[en.y][en.x] = 2; player.atk += 10; }
        else { addLog(`ğŸ’€ æ“Šæ®ºäº† ${en.name}ã€‚`, "info"); }
        gold += en.type === 'boss' ? 500 : 25;
        enemies = enemies.filter(e => e !== en);
    }
}

function endTurn() {
    enemies.forEach(en => {
        if(en.isFrozen > 0) { en.isFrozen--; return; }
        let dx=Math.sign(player.x-en.x), dy=Math.sign(player.y-en.y);
        if(Math.abs(player.x-en.x)+Math.abs(player.y-en.y)===1) {
            player.hp -= en.atk;
            addLog(`ğŸ’¢ ${en.name} æ”»æ“Šäº†ä½ ï¼Œé€ æˆ ${Math.floor(en.atk)} å‚·å®³ï¼`, "danger");
        } else if(en.type==='boss' || dungeon[en.y+dy][en.x+dx]===0) { en.x+=dx; en.y+=dy; }
    });
    player.mp = Math.min(player.maxMp, player.mp + player.regen);
    if(player.hp <= 0) { alert("å†’éšªçµ‚çµ..."); location.reload(); }
    updateUI();
}

function openShop() {
    document.getElementById('shop-ui').style.display='block';
    let list=document.getElementById('shop-list'); list.innerHTML="";
    [{n:"ğŸ§ª èƒ½é‡ä¸Šé™+10", p:80, f:()=>{player.maxMp+=10; player.mp+=10;}},
     {n:"â¤ï¸ ç”Ÿå‘½ä¸Šé™+20", p:60, f:()=>{player.maxHp+=20; player.hp+=20;}},
     {n:"ğŸŒ€ å›é­”é€Ÿåº¦+1", p:150, f:()=>{player.regen+=1;}}].forEach(i=>{
        let d=document.createElement('div'); d.className="shop-item";
        d.innerHTML=`<span>${i.n}</span><span class="price">ğŸ’°${i.p}</span>`;
        d.onclick=()=>{ if(gold>=i.p){gold-=i.p; i.f(); openShop(); updateUI();} };
        list.appendChild(d);
    });
    Object.keys(SPELLS).forEach(k=>{
        if(!player.unlockedSpells.includes(k)){
            let s=SPELLS[k]; let d=document.createElement('div'); d.className="shop-item";
            d.innerHTML=`<span>ğŸ“œ å­¸ç¿’ ${s.name} (${k})</span><span class="price">ğŸ’°${s.price}</span>`;
            d.onclick=()=>{ if(gold>=s.price){gold-=s.price; player.unlockedSpells.push(k); openShop(); updateUI();} };
            list.appendChild(d);
        }
    });
}
function closeShop(){ document.getElementById('shop-ui').style.display='none'; }

function draw() {
    ctx.clearRect(0,0,750,600); ctx.textAlign="center"; ctx.textBaseline="middle";
    for(let y=0; y<GH; y++) for(let x=0; x<GW; x++) {
        ctx.fillStyle = dungeon[y][x]===1?"#222":"#080808"; ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
        if(dungeon[y][x]===2) ctx.fillText("ğŸªœ", x*TILE+TILE/2, y*TILE+TILE/2);
        if(dungeon[y][x]===3) ctx.fillText("ğŸ›’", x*TILE+TILE/2, y*TILE+TILE/2);
    }
    effects.forEach((eff, i)=>{
        ctx.globalAlpha=eff.life/10; ctx.fillStyle=eff.type==='fire'?"#ff4400":"#00ccff";
        ctx.fillRect(eff.x*TILE, eff.y*TILE, TILE, TILE);
        eff.life--; if(eff.life<=0) effects.splice(i,1);
    });
    ctx.globalAlpha=1;
    enemies.forEach(en=>{
        ctx.font=en.type==='boss'?"35px Arial":"22px Arial";
        ctx.fillStyle=en.isFrozen>0?"#00ccff":(en.type==='boss'?"#ff0000":"#eee");
        ctx.fillText(en.emoji||"ğŸ‘º", en.x*TILE+TILE/2, en.y*TILE+TILE/2);
        const bw=TILE*0.8; ctx.fillStyle="#444"; ctx.fillRect(en.x*TILE+(TILE-bw)/2, en.y*TILE+TILE-4, bw, 3);
        ctx.fillStyle="#f00"; ctx.fillRect(en.x*TILE+(TILE-bw)/2, en.y*TILE+TILE-4, bw*(en.hp/en.maxHp), 3);
    });
    ctx.font="24px Arial"; ctx.fillText("ğŸ§™", player.x*TILE+TILE/2, player.y*TILE+TILE/2);
}

function updateUI() {
    document.getElementById('s-hp').innerText=`${Math.floor(player.hp)}/${player.maxHp}`;
    document.getElementById('s-mp').innerText=`${player.mp}/${player.maxMp}`;
    document.getElementById('s-gold').innerText=gold;
    document.getElementById('s-floor').innerText=floor;
    document.getElementById('s-loop').innerText=loopCount;
    document.getElementById('s-atk').innerText=player.atk;
    let b=enemies.find(e=>e.type==='boss');
    if(b) document.getElementById('boss-hp-fill').style.width=(b.hp/b.maxHp*100)+"%";
    let ui=document.getElementById('spell-list-ui'); ui.innerHTML="";
    Object.keys(SPELLS).forEach(k=>{
        let s=SPELLS[k]; let lock=player.unlockedSpells.includes(k);
        ui.innerHTML+=`<div class="spell-card ${lock?'unlocked':''}">
            <span class="spell-key">${k}</span> ${s.name} (${s.cost}MP)<br><small>${lock?s.desc:'ğŸ”’ æœªè§£é–'}</small>
        </div>`;
    });
}

function addLog(m, cl=""){
    let d=document.createElement('div'); d.className=cl; d.innerText="> "+m;
    const inner=document.getElementById('log-inner'); inner.prepend(d);
}

window.addEventListener('keydown', e=>{
    if(document.getElementById('shop-ui').style.display==='block') return;
    const k=e.key.toUpperCase();
    if(['W','A','S','D','ARROWUP','ARROWLEFT','ARROWDOWN','ARROWRIGHT'].includes(k)){
        if(k==='W'||k==='ARROWUP') tryMove(0,-1);
        else if(k==='S'||k==='ARROWDOWN') tryMove(0,1);
        else if(k==='A'||k==='ARROWLEFT') tryMove(-1,0);
        else if(k==='D'||k==='ARROWRIGHT') tryMove(1,0);
    } else if(SPELLS[k]) castSpell(k);
});

initLevel(); setInterval(draw, 50);
</script>
</body>
</html>
