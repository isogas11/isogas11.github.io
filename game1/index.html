<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ·±æ·µçµæ‰‹ï¼šé›™é‡å•†åº—ç‰ˆ</title>
    <style>
        body { background: #050505; color: #eee; font-family: 'Consolas', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; overflow: hidden; }
        .game-layout { display: flex; gap: 15px; padding: 15px; width: 1450px; height: 98vh; box-sizing: border-box; }
        .sidebar { width: 240px; background: #151515; padding: 15px; border: 2px solid #333; border-radius: 8px; }
        .stat-line { font-size: 14px; line-height: 2.2; border-bottom: 1px solid #222; }
        .stat-val { float: right; font-weight: bold; }
        #game-area { position: relative; }
        canvas { background: #000; border: 4px solid #3498db; }
        
        .right-panel { width: 400px; display: flex; flex-direction: column; gap: 10px; }
        .spell-card { background: #1e272e; padding: 8px; border: 1px solid #3d3d3d; border-radius: 5px; margin-bottom: 5px; opacity: 0.4; position: relative; }
        .spell-card.unlocked { opacity: 1; border-color: #3498db; }
        .cd-overlay { position: absolute; top:0; left:0; height:100%; background: rgba(0,0,0,0.5); width: 0%; pointer-events: none; }
        
        .log { height: 180px; background: #000; padding: 10px; font-size: 13px; border: 1px solid #333; overflow-y: auto; color: #aaa; border-radius: 8px; }
        
        /* å•†åº— UI */
        #shop-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 450px; background: #1a1a1a; border: 3px solid #f1c40f; padding: 20px; display: none; z-index: 100; border-radius: 10px; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #333; cursor: pointer; }
        .shop-item:hover { background: #222; }
        .item-desc { font-size: 12px; color: #888; display: block; }
        .price { color: #f1c40f; font-weight: bold; }
        
        .passive-tag { display: inline-block; background: #27ae60; color: white; padding: 2px 5px; border-radius: 3px; font-size: 11px; margin: 2px; }
    </style>
</head>
<body>

<div id="shop-ui">
    <h2 id="shop-title" style="text-align:center; margin-top:0;">ğŸ›’ å•†åº—</h2>
    <div id="shop-list"></div>
    <button onclick="closeShop()" style="width:100%; margin-top:15px; padding:10px; background:#444; color:white; border:none; cursor:pointer;">é›¢é–‹</button>
</div>

<div class="game-layout">
    <div class="sidebar">
        <h3 style="color:#3498db; text-align:center;">ğŸ§™ å¥§è¡“ä¸»å®°</h3>
        <div class="stat-line">â¤ï¸ ç”Ÿå‘½ <span id="s-hp" class="stat-val" style="color:#e74c3c">100/100</span></div>
        <div class="stat-line">ğŸ§ª èƒ½é‡ <span id="s-mp" class="stat-val" style="color:#3498db">20/20</span></div>
        <div class="stat-line">âš”ï¸ è¿‘æˆ° <span id="s-matk" class="stat-val" style="color:#e67e22">10</span></div>
        <div class="stat-line">ğŸ”® è¡“åŠ› <span id="s-atk" class="stat-val" style="color:#9b59b6">15</span></div>
        <div class="stat-line">ğŸ›¡ï¸ é˜²ç¦¦ <span id="s-def" class="stat-val" style="color:#95a5a6">0</span></div>
        <div class="stat-line">ğŸ’° é‡‘å¹£ <span id="s-gold" class="stat-val" style="color:#f1c40f">0</span></div>
        <div class="stat-line">ğŸ° å±¤æ•¸ <span id="s-floor" class="stat-val">1</span></div>
        <hr border="0" style="border-top:1px solid #333">
        <h4>è¢«å‹•èƒ½åŠ›:</h4>
        <div id="passive-list"></div>
        <hr border="0" style="border-top:1px solid #333">
        <h4>é­”æ³•å¿«æ·éµ:</h4>
        <div id="spell-list-ui"></div>
    </div>

    <div id="game-area"><canvas id="gameCanvas" width="750" height="600"></canvas></div>

    <div class="right-panel">
        <div class="log" id="log"><div id="log-inner"></div></div>
        <div style="background:#151515; border:2px solid #333; padding:15px; border-radius:8px; flex-grow:1;">
            <h4 style="margin-top:0; color:#f1c40f;">ğŸ“œ åœ–ä¾‹èªªæ˜</h4>
            <div style="font-size:13px; color:#999; line-height:2;">
                ğŸª ä¸€èˆ¬å•†åº— (å±¬æ€§èˆ‡è¢«å‹•)<br>
                ğŸ”® é­”æ³•å•†åº— (æŠ€èƒ½è§£é–)<br>
                ğŸªœ ä¸‹ä¸€å±¤å…¥å£
            </div>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 30, GW = 25, GH = 20;

let floor = 1, gold = 100;
let player = { 
    x: 5, y: 5, hp: 100, maxHp: 100, mp: 30, maxMp: 30, 
    atk: 15, meleeAtk: 10, defense: 0, regen: 1,
    unlockedSpells: ['Q'],
    spellCD: { 'Q':0, 'E':0, 'R':0, 'F':0, 'V':0, 'G':0 },
    passives: [] // å­˜æ”¾æ“æœ‰çš„è¢«å‹• ID
};

let dungeon = [], enemies = [], effects = [], moveHistory = [];

const SPELLS = {
    'Q': { name: 'ç«çƒè¡“', cost: 3, cd: 0, desc: 'å°„ç¨‹5çš„ç«çƒ', price: 0 },
    'E': { name: 'å†°çˆ†é™£', cost: 6, cd: 4, desc: '5x5å‡çµ3å›åˆ', price: 200 },
    'R': { name: 'è¿”å›è¡“', cost: 2, cd: 6, desc: 'å›åˆ°5æ­¥å‰', price: 150 },
    'F': { name: 'è¬åŠè¨£', cost: 10, cd: 10, desc: 'å…¨å±è¿½è¹¤æ‰“æ“Š', price: 400 },
    'V': { name: 'æ²»ç™’è¡“', cost: 5, cd: 8, desc: 'æ¢å¾©30%ç”Ÿå‘½', price: 250 },
    'G': { name: 'é‡åŠ›å ´', cost: 12, cd: 15, desc: 'å…¨å±é«˜å‚·+å¼·æ§', price: 500 }
};

// --- è¢«å‹•èƒ½åŠ›å®šç¾© ---
const PASSIVES = {
    'lifesteal': { name: 'å—œè¡€è¡“', desc: 'è¿‘æˆ°æ”»æ“Šæ™‚æ¢å¾© 5% ç”Ÿå‘½', price: 300 },
    'thorns': { name: 'èŠæ£˜è£ç”²', desc: 'å—åˆ°æ”»æ“Šæ™‚åå½ˆ 20% å‚·å®³', price: 250 },
    'crit': { name: 'å¥§è¡“æš´æ“Š', desc: 'é­”æ³•å‚·å®³æœ‰ 20% æ©Ÿç‡ç¿»å€', price: 350 },
    'wisdom': { name: 'è³¢è€…ä¹‹çŸ³', desc: 'æ¯å›åˆé¡å¤–æ¢å¾© 1 é»èƒ½é‡', price: 400 },
    'speed': { name: 'ç¥é€Ÿ', desc: 'æ¯ç§»å‹• 5 æ­¥ç¸®çŸ­æ‰€æœ‰æŠ€èƒ½ 1 CD', price: 300 },
    'shield': { name: 'èƒ½é‡è­·ç›¾', desc: 'å—å‚·æ™‚å„ªå…ˆæ‰£é™¤èƒ½é‡(1:2)', price: 450 }
};

function initLevel() {
    dungeon = Array(GH).fill().map(() => Array(GW).fill(1));
    enemies = []; effects = []; moveHistory = [];
    
    let cx = 12, cy = 10; player.x = cx; player.y = cy;
    for(let i=0; i<600; i++) {
        dungeon[cy][cx] = 0;
        let d = Math.floor(Math.random()*4);
        if(d===0 && cy>1) cy--; else if(d===1 && cy<GH-2) cy++;
        else if(d===2 && cx>1) cx--; else if(d===3 && cx<GW-2) cx++;
    }
    
    place(2, 1); // ğŸªœ å‡ºå£
    place(3, 1); // ğŸª ä¸€èˆ¬å•†åº—
    place(4, 1); // ğŸ”® é­”æ³•å•†åº—
    
    for(let i=0; i<3 + Math.floor(floor/2); i++) spawnEnemy();
    updateUI();
}

function spawnEnemy() {
    let x, y;
    do { x = Math.floor(Math.random()*GW); y = Math.floor(Math.random()*GH); }
    while(dungeon[y][x] !== 0 || (x===player.x && y===player.y));
    enemies.push({ x, y, hp: 40+floor*15, maxHp: 40+floor*15, atk: 8+floor*2, isFrozen: 0 });
}

function place(val, n) {
    for(let i=0; i<n; i++) {
        let x, y;
        do { x = Math.floor(Math.random()*GW); y = Math.floor(Math.random()*GH); }
        while(dungeon[y][x] !== 0);
        dungeon[y][x] = val;
    }
}

function tryMove(dx, dy) {
    let nx = player.x + dx, ny = player.y + dy;
    if (nx < 0 || nx >= GW || ny < 0 || ny >= GH || dungeon[ny][nx] === 1) return;

    if (dungeon[ny][nx] === 3) { openGeneralShop(); return; }
    if (dungeon[ny][nx] === 4) { openMagicShop(); return; }

    let target = enemies.find(e => e.x === nx && e.y === ny);
    if (target) {
        // è¿‘æˆ°æ”»æ“Š
        let dmg = player.meleeAtk;
        dealDamage(target, dmg);
        addLog(`âš”ï¸ è¿‘æˆ°æ”»æ“Šé€ æˆ ${dmg} å‚·å®³`);
        
        // è¢«å‹•ï¼šå—œè¡€
        if(player.passives.includes('lifesteal')) {
            let heal = Math.floor(dmg * 0.05);
            player.hp = Math.min(player.maxHp, player.hp + heal);
            if(heal > 0) addLog(`ğŸ©¸ å—œè¡€æ¢å¾©äº† ${heal} ç”Ÿå‘½`);
        }
        endTurn();
    } else {
        player.x = nx; player.y = ny;
        if (dungeon[ny][nx] === 2) { floor++; initLevel(); return; }
        
        // è¢«å‹•ï¼šç¥é€Ÿ
        moveHistory.push({x: nx, y: ny});
        if(player.passives.includes('speed') && moveHistory.length % 5 === 0) {
            for(let k in player.spellCD) if(player.spellCD[k]>0) player.spellCD[k]--;
            addLog("ğŸ‘Ÿ ç¥é€Ÿè§¸ç™¼ï¼šæŠ€èƒ½å†·å»ç¸®çŸ­ï¼");
        }
        endTurn();
    }
}

function castSpell(key) {
    if (!player.unlockedSpells.includes(key)) return;
    if (player.spellCD[key] > 0 || player.mp < SPELLS[key].cost) return;
    
    let s = SPELLS[key];
    player.mp -= s.cost;
    player.spellCD[key] = s.cd;
    addLog(`âœ¨ æ–½æ”¾ ${s.name}ï¼`, "magic");

    let spellDmg = player.atk;
    // è¢«å‹•ï¼šæš´æ“Š
    if(player.passives.includes('crit') && Math.random() < 0.2) {
        spellDmg *= 2;
        addLog("ğŸ’¥ å¥§è¡“æš´æ“Šï¼å‚·å®³ç¿»å€ï¼", "magic");
    }

    if (key === 'Q') {
        [[0,-1],[0,1],[-1,0],[1,0]].forEach(d => {
            for(let i=1; i<=5; i++) {
                let tx = player.x+d[0]*i, ty = player.y+d[1]*i;
                effects.push({x: tx, y: ty, life: 6, type: 'fire'});
                let target = enemies.find(e => e.x === tx && e.y === ty);
                if(target) { dealDamage(target, spellDmg * 2); break; }
            }
        });
    } else if (key === 'E') {
        for(let dy=-2; dy<=2; dy++) for(let dx=-2; dx<=2; dx++) {
            let tx=player.x+dx, ty=player.y+dy;
            effects.push({x: tx, y: ty, life: 8, type: 'ice'});
            let target = enemies.find(e => e.x === tx && e.y === ty);
            if(target) { target.isFrozen=3; dealDamage(target, spellDmg); }
        }
    } else if (key === 'R') {
        let last = moveHistory[Math.max(0, moveHistory.length-5)] || {x:player.x, y:player.y};
        player.x = last.x; player.y = last.y;
    } else if (key === 'F') {
        enemies.forEach(en => {
            effects.push({x: en.x, y: en.y, life: 10, type: 'sword'});
            dealDamage(en, spellDmg * 1.5);
        });
    } else if (key === 'V') {
        player.hp = Math.min(player.maxHp, player.hp + player.maxHp * 0.3);
        effects.push({x: player.x, y: player.y, life: 10, type: 'heal'});
    } else if (key === 'G') {
        enemies.forEach(en => {
            en.isFrozen = 2; dealDamage(en, 60);
            effects.push({x: en.x, y: en.y, life: 15, type: 'gravity'});
        });
    }
    endTurn();
}

function dealDamage(en, dmg) {
    en.hp -= dmg;
    if(en.hp <= 0) { gold += 30; enemies = enemies.filter(e => e !== en); }
}

function endTurn() {
    for (let k in player.spellCD) if (player.spellCD[k] > 0) player.spellCD[k]--;

    enemies.forEach(en => {
        if(en.isFrozen > 0) { en.isFrozen--; return; }
        let dx = Math.sign(player.x - en.x), dy = Math.sign(player.y - en.y);
        
        if(Math.abs(player.x-en.x)+Math.abs(player.y-en.y) === 1) {
            // è¨ˆç®—å‚·å®³èˆ‡é˜²ç¦¦
            let rawDmg = en.atk;
            let finalDmg = Math.max(1, rawDmg - player.defense);
            
            // è¢«å‹•ï¼šèƒ½é‡è­·ç›¾
            if(player.passives.includes('shield') && player.mp > 0) {
                let mpConsume = Math.floor(finalDmg * 0.5);
                player.mp = Math.max(0, player.mp - mpConsume);
                finalDmg = Math.ceil(finalDmg * 0.5);
                addLog(`ğŸ›¡ï¸ è­·ç›¾æŠµæ“‹äº†éƒ¨åˆ†å‚·å®³ (æ¶ˆè€— ${mpConsume} MP)`);
            }

            player.hp -= finalDmg;
            addLog(`ğŸ’¢ å—å‚· -${finalDmg} HP`, "danger");

            // è¢«å‹•ï¼šèŠæ£˜
            if(player.passives.includes('thorns')) {
                let reflect = Math.floor(rawDmg * 0.2);
                dealDamage(en, reflect);
                addLog(`ğŸŒµ èŠæ£˜åå½ˆäº† ${reflect} å‚·å®³`);
            }
        } else {
            let nx = en.x + dx, ny = en.y + dy;
            if (dungeon[ny][nx] === 0 && !(nx === player.x && ny === player.y) && !enemies.some(e=>e.x===nx && e.y===ny)) {
                en.x = nx; en.y = ny;
            }
        }
    });
    
    // èƒ½é‡æ¢å¾©
    let mRegen = player.regen + (player.passives.includes('wisdom') ? 1 : 0);
    player.mp = Math.min(player.maxMp, player.mp + mRegen/10); 

    if(player.hp <= 0) { alert("å†’éšªçµæŸï¼"); location.reload(); }
    updateUI();
}

// --- å•†åº—ç³»çµ± ---
function openGeneralShop() {
    const shopUI = document.getElementById('shop-ui');
    const list = document.getElementById('shop-list');
    document.getElementById('shop-title').innerHTML = "ğŸª ä¸€èˆ¬å•†åº—";
    shopUI.style.display = 'block';
    list.innerHTML = "";

    const items = [
        { name: "ğŸ’Š å›å¾©ç”Ÿå‘½", desc: "æ¢å¾© 50% æœ€å¤§ç”Ÿå‘½", price: 50, effect: () => { player.hp = Math.min(player.maxHp, player.hp + player.maxHp*0.5); } },
        { name: "âš”ï¸ ç£¨åˆ€çŸ³", desc: "è¿‘æˆ°æ”»æ“ŠåŠ› +5", price: 100, effect: () => { player.meleeAtk += 5; } },
        { name: "ğŸ›¡ï¸ éµç”²ç‰‡", desc: "é˜²ç¦¦åŠ› +2", price: 100, effect: () => { player.defense += 2; } },
        { name: "â¤ï¸ é«”åŠ›å¢å¹…", desc: "æœ€å¤§ç”Ÿå‘½ +20", price: 150, effect: () => { player.maxHp += 20; player.hp += 20; } }
    ];

    items.forEach(item => {
        let div = document.createElement('div');
        div.className = "shop-item";
        div.innerHTML = `<div><b>${item.name}</b><br><small class="item-desc">${item.desc}</small></div><span class="price">ğŸ’°${item.price}</span>`;
        div.onclick = () => { if(gold >= item.price) { gold -= item.price; item.effect(); addLog(`ğŸ›’ è³¼è²·äº† ${item.name}`); openGeneralShop(); updateUI(); } };
        list.appendChild(div);
    });

    // éš¨æ©Ÿåˆ—å‡º 3 å€‹æœªæ“æœ‰çš„è¢«å‹•
    Object.keys(PASSIVES).forEach(pid => {
        if(!player.passives.includes(pid)) {
            let p = PASSIVES[pid];
            let div = document.createElement('div');
            div.className = "shop-item";
            div.innerHTML = `<div><b style="color:#27ae60">ğŸ’ ${p.name}</b><br><small class="item-desc">${p.desc}</small></div><span class="price">ğŸ’°${p.price}</span>`;
            div.onclick = () => { if(gold >= p.price) { gold -= p.price; player.passives.push(pid); addLog(`ğŸ’¡ ç²å¾—è¢«å‹•ï¼š${p.name}`); openGeneralShop(); updateUI(); } };
            list.appendChild(div);
        }
    });
}

function openMagicShop() {
    const shopUI = document.getElementById('shop-ui');
    const list = document.getElementById('shop-list');
    document.getElementById('shop-title').innerHTML = "ğŸ”® é­”æ³•å•†åº—";
    shopUI.style.display = 'block';
    list.innerHTML = "";

    Object.keys(SPELLS).forEach(key => {
        if (!player.unlockedSpells.includes(key)) {
            let s = SPELLS[key];
            let div = document.createElement('div');
            div.className = "shop-item";
            div.innerHTML = `<div><b>ğŸ“œ å­¸ç¿’ ${s.name}</b><br><small class="item-desc">${s.desc}</small></div><span class="price">ğŸ’°${s.price}</span>`;
            div.onclick = () => { if(gold >= s.price) { gold -= s.price; player.unlockedSpells.push(key); addLog(`ğŸ“– ç¿’å¾—ï¼š${s.name}`); openMagicShop(); updateUI(); } };
            list.appendChild(div);
        }
    });
    
    // æä¾›æ³•è¡“å¼·åº¦å‡ç´š
    let upgPrice = 200 + floor * 50;
    let div = document.createElement('div');
    div.className = "shop-item";
    div.innerHTML = `<div><b>ğŸ§ª å¥§è¡“å¼·åŒ–</b><br><small class="item-desc">è¡“åŠ›(é­”æ³•å‚·å®³) +5</small></div><span class="price">ğŸ’°${upgPrice}</span>`;
    div.onclick = () => { if(gold >= upgPrice) { gold -= upgPrice; player.atk += 5; openMagicShop(); updateUI(); } };
    list.appendChild(div);
}

function closeShop() { document.getElementById('shop-ui').style.display = 'none'; }

function updateUI() {
    document.getElementById('s-hp').innerText = `${Math.floor(player.hp)}/${player.maxHp}`;
    document.getElementById('s-mp').innerText = `${Math.floor(player.mp)}/${player.maxMp}`;
    document.getElementById('s-matk').innerText = player.meleeAtk;
    document.getElementById('s-atk').innerText = player.atk;
    document.getElementById('s-def').innerText = player.defense;
    document.getElementById('s-gold').innerText = gold;
    document.getElementById('s-floor').innerText = floor;
    
    let pUI = document.getElementById('passive-list');
    pUI.innerHTML = player.passives.map(p => `<span class="passive-tag">${PASSIVES[p].name}</span>`).join('');

    let sUI = document.getElementById('spell-list-ui');
    sUI.innerHTML = "";
    Object.keys(SPELLS).forEach(key => {
        let s = SPELLS[key];
        let unlocked = player.unlockedSpells.includes(key);
        let cd = player.spellCD[key];
        sUI.innerHTML += `
            <div class="spell-card ${unlocked?'unlocked':''}">
                <div class="cd-overlay" style="width:${(cd/s.cd)*100}%"></div>
                <span style="font-weight:bold">[${key}] ${s.name}</span>
                <div style="font-size:11px; color:#aaa;">${unlocked ? (cd > 0 ? `å†·å» ${cd} å›åˆ` : s.desc) : 'ğŸ”’ æœªå­¸æœƒ'}</div>
            </div>`;
    });
}

function draw() {
    ctx.clearRect(0,0,750,600);
    for(let y=0; y<GH; y++) for(let x=0; x<GW; x++) {
        ctx.fillStyle = dungeon[y][x] === 1 ? "#222" : "#080808";
        ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
        ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.font = "20px Arial";
        if(dungeon[y][x] === 2) ctx.fillText("ğŸªœ", x*TILE+15, y*TILE+15);
        if(dungeon[y][x] === 3) ctx.fillText("ğŸª", x*TILE+15, y*TILE+15);
        if(dungeon[y][x] === 4) ctx.fillText("ğŸ”®", x*TILE+15, y*TILE+15);
    }
    effects.forEach((eff, i) => {
        ctx.globalAlpha = eff.life / 10;
        ctx.fillStyle = eff.type==='fire'?"#f39c12":eff.type==='ice'?"#3498db":eff.type==='sword'?"#ecf0f1":eff.type==='heal'?"#2ecc71":"#9b59b6";
        ctx.fillRect(eff.x*TILE, eff.y*TILE, TILE, TILE);
        eff.life--; if(eff.life<=0) effects.splice(i,1);
    });
    ctx.globalAlpha = 1;
    enemies.forEach(en => {
        ctx.fillStyle = en.isFrozen > 0 ? "#3498db" : "#e74c3c";
        ctx.fillText("ğŸ‘º", en.x*TILE+15, en.y*TILE+15);
    });
    ctx.fillText("ğŸ§™", player.x*TILE+15, player.y*TILE+15);
}

function addLog(m, cl="") {
    let d = document.createElement('div'); d.className = cl; d.innerText = "> " + m;
    document.getElementById('log-inner').prepend(d);
}

window.addEventListener('keydown', e => {
    if (document.getElementById('shop-ui').style.display === 'block') return;
    const k = e.key.toUpperCase();
    if(['W','A','S','D','ARROWUP','ARROWLEFT','ARROWDOWN','ARROWRIGHT'].includes(k)) {
        if(k==='W'||k==='ARROWUP') tryMove(0,-1);
        else if(k==='S'||k==='ARROWDOWN') tryMove(0,1);
        else if(k==='A'||k==='ARROWLEFT') tryMove(-1,0);
        else if(k==='D'||k==='ARROWRIGHT') tryMove(1,0);
    } else if(SPELLS[k]) {
        castSpell(k);
    }
});

initLevel();
setInterval(draw, 50);
</script>
</body>
</html>
